<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Drew Dimmery">
<meta name="dcterms.date" content="2022-05-10">
<meta name="description" content="In this demo, I’m going to walk through an example experimental design using methods from our recent paper on Balanced Design.">

<title>Drew Dimmery – Using SoftBlock to Design an Experiment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-Y7YLFF5F90"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-Y7YLFF5F90', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">

<script>
MathJax = {
  tex: {
    inlineMath: {'[+]': [['$', '$']]}
  },
  chtml: {
    font: 'mathjax-pagella'
  },
  loader: {
    paths: {
      font: 'https://cdn.jsdelivr.net/npm/@mathjax',
      'mathjax-euler-extension': '[font]/mathjax-euler-font-extension',
    },
    load: ['input/tex-base', '[tex]/newcommand', '[tex]/action', 'output/chtml','[mathjax-euler-extension]/chtml']
  },
  startup: {
    ready() {
      MathJax.startup.defaultReady();
      MathJax._.output.fonts.generic = {
        chtml_ts: {GenericFont: MathJax._.output.fonts['mathjax-pagella'].chtml_ts.MathJaxPagellaFont}
      }
    }
  }
};
</script>
<link href="../../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../../site_libs/datatables-binding-0.34.0/datatables.js"></script>
<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Drew Dimmery - Using SoftBlock to Design an Experiment">
<meta property="og:description" content="In this demo, I’m going to walk through an example experimental design using methods from our recent paper on Balanced Design.">
<meta property="og:image" content="https://ddimmery.com/posts/softblock-demo/main-image.png">
<meta property="og:site_name" content="Drew Dimmery">
<meta property="og:image:height" content="636">
<meta property="og:image:width" content="1200">
<meta name="twitter:title" content="Drew Dimmery - Using SoftBlock to Design an Experiment">
<meta name="twitter:description" content="In this demo, I’m going to walk through an example experimental design using methods from our recent paper on Balanced Design.">
<meta name="twitter:image" content="https://ddimmery.com/posts/softblock-demo/main-image.png">
<meta name="twitter:creator" content="@drewdim">
<meta name="twitter:site" content="@drewdim">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="636">
<meta name="twitter:image-width" content="1200">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Drew Dimmery</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Using SoftBlock to Design an Experiment</h1>
                  <div>
        <div class="description">
          In this demo, I’m going to walk through an example experimental design using methods from our <a href="https://arxiv.org/abs/2010.11332">recent paper on Balanced Design</a>.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">experiments</div>
                <div class="quarto-category">demo</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://ddimmery.com">Drew Dimmery</a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://www.hertie-school.org/en/datasciencelab">
              The Hertie School
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 10, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      <p>This is a demo of using SoftBlock for experimental design for a notional randomization of precincts in North Carolina. To optimize power, we focus on ensuring very similar patterns of prior voting patterns in treatment and in control. This demo walks through all the necessary steps for this process and shows how to perform estimation of average and heterogeneous effects.</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#implementation-of-methods" id="toc-implementation-of-methods" class="nav-link" data-scroll-target="#implementation-of-methods">Implementation of methods</a>
  <ul>
  <li><a href="#description" id="toc-description" class="nav-link" data-scroll-target="#description">Description</a></li>
  <li><a href="#source-code" id="toc-source-code" class="nav-link" data-scroll-target="#source-code">Source Code</a></li>
  </ul></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data Preparation</a>
  <ul>
  <li><a href="#get-precinct-data" id="toc-get-precinct-data" class="nav-link" data-scroll-target="#get-precinct-data">Get Precinct data</a>
  <ul class="collapse">
  <li><a href="#results-data" id="toc-results-data" class="nav-link" data-scroll-target="#results-data">Results Data</a></li>
  <li><a href="#shapefiles" id="toc-shapefiles" class="nav-link" data-scroll-target="#shapefiles">Shapefiles</a></li>
  </ul></li>
  <li><a href="#aggregate-data-and-join" id="toc-aggregate-data-and-join" class="nav-link" data-scroll-target="#aggregate-data-and-join">Aggregate Data and Join</a></li>
  <li><a href="#add-some-geographic-features" id="toc-add-some-geographic-features" class="nav-link" data-scroll-target="#add-some-geographic-features">Add some geographic features</a></li>
  </ul></li>
  <li><a href="#assign-treatment-four-ways" id="toc-assign-treatment-four-ways" class="nav-link" data-scroll-target="#assign-treatment-four-ways">Assign treatment four ways</a></li>
  <li><a href="#power-simulation" id="toc-power-simulation" class="nav-link" data-scroll-target="#power-simulation">Power simulation</a>
  <ul>
  <li><a href="#simulate-each-design" id="toc-simulate-each-design" class="nav-link" data-scroll-target="#simulate-each-design">Simulate each design</a></li>
  <li><a href="#power-comparison" id="toc-power-comparison" class="nav-link" data-scroll-target="#power-comparison">Power Comparison</a></li>
  </ul></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul>
  <li><a href="#average-effects" id="toc-average-effects" class="nav-link" data-scroll-target="#average-effects">Average Effects</a></li>
  <li><a href="#plot-average-effects" id="toc-plot-average-effects" class="nav-link" data-scroll-target="#plot-average-effects">Plot Average Effects</a></li>
  <li><a href="#heterogeneous-effects" id="toc-heterogeneous-effects" class="nav-link" data-scroll-target="#heterogeneous-effects">Heterogeneous Effects</a></li>
  <li><a href="#estimate-htes" id="toc-estimate-htes" class="nav-link" data-scroll-target="#estimate-htes">Estimate HTEs</a></li>
  <li><a href="#plot-hte-distributions" id="toc-plot-hte-distributions" class="nav-link" data-scroll-target="#plot-hte-distributions">Plot HTE distributions</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In particular, I’m going to imagine that I’m designing an experiment in which I assign different treatments to particular precincts in North Carolina. In order to optimize power, of course, we want to make sure that our two test groups look as similar as possible in terms of prior voting patterns.</p>
<p>Thus, the steps in this design will be:</p>
<ol type="1">
<li>Collect relevant historical data.</li>
<li>Define variables on which we wish to balance.</li>
<li>Allocate treatment assignment using new methods.</li>
<li>Simulate the power of hypothesis tests under the proposed design.</li>
<li>Fake some outcome data and analyze it for average and heterogeneous treatment effects.</li>
</ol>
</section>
<section id="implementation-of-methods" class="level1">
<h1>Implementation of methods</h1>
<section id="description" class="level2">
<h2 class="anchored" data-anchor-id="description">Description</h2>
<p>The relevant API is a function with <code>tidyverse</code> semantics called <code>assign_softblock</code> (or <code>assign_greedy_neighbors</code>). These functions accept a vector of columns to be used in the design. The SoftBlock version additionally accepts two arguments, <code>.s2</code> for the bandwidth of the RBF kernel to use in the construction of a similarity matrix as well as <code>.neighbors</code> which indicates the number of nearest neighbors to include in the graph on which to construct the spanning tree. These parameters don’t generally need to be modified.</p>
</section>
<section id="source-code" class="level2">
<h2 class="anchored" data-anchor-id="source-code">Source Code</h2>
<details>
<summary>
See source code
</summary>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">writeLines</span>(<span class="fu">readLines</span>(<span class="st">"https://raw.githubusercontent.com/ddimmery/softblock/master/r_implementation.R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>library(Matrix)
library(igraph)
library(FNN)
library(hash)

assign_greedily &lt;- function(graph) {
    adj_mat = igraph::as_adjacency_matrix(graph, type="both", sparse=TRUE) != 0
    N = nrow(adj_mat)
    root_id = make.keys(sample(N, 1))

    a = rbinom(1, 1, 0.5)
    visited = hash()

    random_order = make.keys(sample(N))
    unvisited = hash(random_order, random_order)

    colors = hash()
    stack = hash()

    stack[[root_id]] &lt;- a
    tentative_color = rbinom(N, 1, 0.5)
    while ((!is.empty(unvisited)) || (!is.empty(stack))) {
        if (is.empty(stack)) {
            cur_node = keys(unvisited)[1]
            del(cur_node, unvisited)
            color = tentative_color[as.integer(cur_node)]
        } else {
            cur_node = keys(stack)[1]
            color = stack[[cur_node]]
            del(cur_node, stack)
            del(cur_node, unvisited)
        }
        visited[[cur_node]] = cur_node
        colors[[cur_node]] = color
        children = make.keys(which(adj_mat[as.integer(cur_node), ]))
        for (child in children) {
            if(has.key(child, unvisited)) {
                stack[[child]] = 1 - color
            }
        }
    }
    values(colors, keys=1:N)
}


assign_softblock &lt;- function(.data, cols, .s2=2, .neighbors=6) {
    expr &lt;- rlang::enquo(cols)
    pos &lt;- tidyselect::eval_select(expr, data = .data)
    df_cov &lt;- rlang::set_names(.data[pos], names(pos))
    cov_mat = scale(model.matrix(~.+0, df_cov))
    N = nrow(cov_mat)
    st = lubridate::now()
    knn = FNN::get.knn(cov_mat, k=.neighbors)
    st = lubridate::now()
    knn.adj = Matrix::sparseMatrix(i=rep(1:N, .neighbors), j=c(knn$nn.index), x=exp(-c(knn$nn.dist) / .s2))
    knn.graph &lt;- graph_from_adjacency_matrix(knn.adj, mode="plus", weighted=TRUE, diag=FALSE)
    E(knn.graph)$weight &lt;- (-1 * E(knn.graph)$weight)
    st = lubridate::now()
    mst.graph = igraph::mst(knn.graph)
    E(mst.graph)$weight &lt;- (-1 * E(mst.graph)$weight)
    st = lubridate::now()
    assignments &lt;- assign_greedily(mst.graph)
    .data$treatment &lt;- assignments
    attr(.data, "laplacian") &lt;- igraph::laplacian_matrix(mst.graph, normalize=TRUE, sparse=TRUE)
    .data
}

assign_greedy_neighbors &lt;- function(.data, cols) {
    expr &lt;- rlang::enquo(cols)
    pos &lt;- tidyselect::eval_select(expr, data = .data)
    df_cov &lt;- rlang::set_names(.data[pos], names(pos))
    cov_mat = scale(model.matrix(~.+0, df_cov))
    N = nrow(cov_mat)
    knn = FNN::get.knn(cov_mat, k=1)
    knn.adj = Matrix::sparseMatrix(i=1:N, j=c(knn$nn.index), x=c(knn$nn.dist))
    knn.graph &lt;- graph_from_adjacency_matrix(knn.adj, mode="plus", weighted=TRUE, diag=FALSE)
    assignments &lt;- assign_greedily(knn.graph)
    .data$treatment &lt;- assignments
    attr(.data, "laplacian") &lt;- igraph::laplacian_matrix(knn.graph, normalize=TRUE, sparse=TRUE)
    .data
}

assign_matched_pairs &lt;- function(.data, cols, .s2=2, .neighbors=6) {
    expr &lt;- rlang::enquo(cols)
    pos &lt;- tidyselect::eval_select(expr, data = .data)
    df_cov &lt;- rlang::set_names(.data[pos], names(pos))
    cov_mat = scale(model.matrix(~.+0, df_cov))
    N = nrow(cov_mat)
    knn = FNN::get.knn(cov_mat, k=.neighbors)
    knn.adj = Matrix::sparseMatrix(i=rep(1:N, .neighbors), j=c(knn$nn.index), x=exp(-c(knn$nn.dist) / .s2))
    knn.graph &lt;- graph_from_adjacency_matrix(knn.adj, mode="plus", weighted=TRUE, diag=FALSE)
    E(knn.graph)$weight &lt;- (-1 * E(knn.graph)$weight)
    mwm.graph = igraph::max_bipartite_match(knn.graph)
    E(mwm.graph)$weight &lt;- (-1 * E(mwm.graph)$weight)
    assignments &lt;- assign_greedily(mwm.graph)
    .data$treatment &lt;- assignments
    attr(.data, "laplacian") &lt;- igraph::laplacian_matrix(mwm.graph, normalize=TRUE, sparse=TRUE)
    .data
}

# library(tibble)
# data = tibble(
#     x1=runif(10),
#     x2=runif(10),
#     x3=rbinom(10, 1, 0.5)
# )
# library(dplyr)
# library(tidyr)
# library(ggplot2)
# data %&gt;% assign_softblock(c(x1, x2)) -&gt; newdata

# ggplot(newdata, aes(x=x1, y=x2, color=factor(treatment), shape=factor(x3))) + geom_point() + theme_minimal()

# newdata %&gt;%
#     attr("laplacian") %&gt;%
#     ifelse(lower.tri(.), ., 0) %&gt;%
#     as_tibble() -&gt; adj_df
# names(adj_df) &lt;- paste0(1:ncol(adj_df))

# adj_df %&gt;%
#     group_by(id_1=as.character(row_number())) %&gt;%
#     gather(id_2, weight, -id_1) %&gt;%
#     filter(weight != 0)  %&gt;%
#     mutate(id_2=as.character(id_2), id=paste(id_1, id_2, sep='-')) -&gt; adj_df

# locs = newdata %&gt;% mutate(id=as.character(row_number())) %&gt;% select(id, x1, x2, x3)

# edges=bind_rows(
# adj_df  %&gt;% inner_join(locs, by=c('id_1'='id')),
# adj_df  %&gt;% inner_join(locs, by=c('id_2'='id'))
# ) %&gt;% arrange(id) %&gt;% ungroup()

# pp = ggplot(newdata, aes(x=x1, y=x2)) +
# geom_line(aes(group=id, size=1), data=edges, color='grey') +
# geom_point(aes(color=factor(treatment), shape=factor(x3), size=2), alpha=.9) +
# scale_size_continuous(range=c(1, 3)) +
# theme_minimal() + theme(legend.position='none')

# print(pp)</code></pre>
</div>
</div>
</details>
</section>
</section>
<section id="data-preparation" class="level1">
<h1>Data Preparation</h1>
<p>This demo will be based on North Carolina data because their Board of Elections makes it very easy to get precinct level data. I’m also only going to use historical data from the most recent election to avoid needing to match precincts across elections.</p>
<p>With access to a full voter file, this section could be drastically improved by incorporating other important elements into the design like demographics.</p>
<section id="get-precinct-data" class="level2 tabset">
<h2 class="tabset anchored" data-anchor-id="get-precinct-data">Get Precinct data</h2>
<section id="results-data" class="level3">
<h3 class="anchored" data-anchor-id="results-data">Results Data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"http://dl.ncsbe.gov/ENRS/2020_11_03/results_pct_20201103.zip"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>zip_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".zip"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, zip_file, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">=</span> <span class="fu">cols</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">County =</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Election Date</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Precinct =</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Contest Group ID</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Contest Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Choice =</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Vote For</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Election Day</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">One Stop</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Absentee by Mail</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Provisional =</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_double</span>(),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Real Precinct</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>(),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">X16 =</span> <span class="fu">col_skip</span>()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(zip_file, <span class="at">col_types=</span>spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...16`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The following named parsers don't match the column names: X16</code></pre>
</div>
</div>
</section>
<section id="shapefiles" class="level3">
<h3 class="anchored" data-anchor-id="shapefiles">Shapefiles</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>url <span class="ot">=</span> <span class="st">"https://s3.amazonaws.com/dl.ncsbe.gov/ShapeFiles/Precinct/SBE_PRECINCTS_20201018.zip"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>temp2 <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(url, temp)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="at">zipfile =</span> temp, <span class="at">exdir =</span> temp2)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>nc_SHP_file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(temp2, <span class="at">pattern =</span> <span class="st">".shp$"</span>,<span class="at">full.names=</span><span class="cn">TRUE</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>shapes <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">read_sf</span>(nc_SHP_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="aggregate-data-and-join" class="level2">
<h2 class="anchored" data-anchor-id="aggregate-data-and-join">Aggregate Data and Join</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="st">`</span><span class="at">Real Precinct</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'Y'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(County, Precinct) <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_vote_pres=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'US PRESIDENT'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">dem_share_pres=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'US PRESIDENT'</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'DEM'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_pres,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">gop_share_pres=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'US PRESIDENT'</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'REP'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_pres,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_vote_senate=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'US SENATE'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">dem_share_senate=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'US SENATE'</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'DEM'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_senate,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">gop_share_senate=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'US SENATE'</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'REP'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_senate,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_vote_gov=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'NC GOVERNOR'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">dem_share_gov=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'NC GOVERNOR'</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'DEM'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_gov,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">gop_share_gov=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'NC GOVERNOR'</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'REP'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_gov,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_vote_house=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="fu">grepl</span>(<span class="st">'US HOUSE OF REPRESENTATIVES DISTRICT'</span>, <span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span>)], <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">dem_share_house=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="fu">grepl</span>(<span class="st">'US HOUSE OF REPRESENTATIVES DISTRICT'</span>, <span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span>) <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'DEM'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_house,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">gop_share_house=</span><span class="fu">sum</span>(<span class="st">`</span><span class="at">Total Votes</span><span class="st">`</span>[<span class="fu">grepl</span>(<span class="st">'US HOUSE OF REPRESENTATIVES DISTRICT'</span>, <span class="st">`</span><span class="at">Contest Name</span><span class="st">`</span>) <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Choice Party</span><span class="st">`</span> <span class="sc">==</span> <span class="st">'REP'</span>], <span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">/</span>total_vote_house</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() <span class="ot">-&gt;</span> results_agg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'County'. You can override using the
`.groups` argument.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inner_join</span>(results_agg, shapes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">'County'</span><span class="ot">=</span><span class="st">'county_nam'</span>, <span class="st">'Precinct'</span><span class="ot">=</span><span class="st">'prec_id'</span>)) <span class="ot">-&gt;</span> df_joined</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(df_joined <span class="sc">%&gt;%</span> <span class="fu">sample_n</span>(<span class="at">size=</span><span class="dv">100</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>geometry), <span class="at">rownames =</span> <span class="cn">FALSE</span>, <span class="at">options=</span><span class="fu">list</span>(<span class="at">scrollX=</span><span class="cn">TRUE</span>, <span class="at">autoWidth =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-1770d66a86dcce969965" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-1770d66a86dcce969965">{"x":{"filter":"none","vertical":false,"data":[["WAKE","WAKE","SWAIN","CRAVEN","BUNCOMBE","ORANGE","GUILFORD","HENDERSON","HOKE","GUILFORD","DAVIDSON","MECKLENBURG","GUILFORD","GUILFORD","GASTON","CARTERET","GUILFORD","RICHMOND","LEE","ROWAN","WAYNE","MADISON","MECKLENBURG","NEW HANOVER","BUNCOMBE","MECKLENBURG","CUMBERLAND","PENDER","CASWELL","HALIFAX","WILKES","WATAUGA","NORTHAMPTON","FRANKLIN","ORANGE","GUILFORD","CABARRUS","HENDERSON","BRUNSWICK","BUNCOMBE","IREDELL","RUTHERFORD","CUMBERLAND","MECKLENBURG","BLADEN","DURHAM","BRUNSWICK","CABARRUS","BURKE","MECKLENBURG","ALEXANDER","WAKE","SAMPSON","CABARRUS","WAYNE","WAKE","HARNETT","DURHAM","CASWELL","YANCEY","ROBESON","ROWAN","COLUMBUS","ALAMANCE","RUTHERFORD","ROBESON","PERQUIMANS","DURHAM","WAKE","JOHNSTON","GUILFORD","GUILFORD","WILKES","WAKE","MADISON","DAVIDSON","STANLY","GUILFORD","GUILFORD","MECKLENBURG","PITT","MECKLENBURG","CLEVELAND","RUTHERFORD","PERQUIMANS","ORANGE","GUILFORD","BRUNSWICK","GUILFORD","LENOIR","UNION","CUMBERLAND","WAKE","BERTIE","UNION","DAVIE","RANDOLPH","GASTON","UNION","FORSYTH"],["16-07","20-11","WHCH","20","21.1","CS1","OR2","SM","01","G32","52","141","G05","H26","40","ASCI","G11","13","C1","04","11","MARS H","235","W25","34.1","128","CC21","CF11","ANDE","HPR","108","02","CREEKS","11","SJ","G40A2","07-00","PV","17","39.2","ST4","14","G4A","113","P502","06","05","02-05","0051","001","E","18-01","HARR","12-04","21","20-04","PR20","35.3","LEAS","06 JAC","17","13","P25B","06E","10A","22","PARKVI","38","16-01","PR04","H24","FR5B","101","01-29","HOT SP","64","0018","NCGR1","H01","021","0200B","015","LAWNDL","06A","BELVID","WC","H20B","16","G65","FC","029C","MB62","04-10","W1","012","03","AS","18","036","304"],[462,626,2005,2615,919,176,291,2513,274,270,3109,1788,192,197,3788,621,209,213,551,3340,196,2992,2103,1014,385,1858,2377,2618,699,237,204,297,134,1265,169,235,348,1289,5288,359,2375,1827,1099,2109,141,125,3280,463,2568,992,1962,493,1295,366,183,406,485,399,531,1197,252,1792,993,1780,1021,1799,1412,383,442,404,272,161,276,368,648,760,918,428,330,1410,399,2578,1362,2057,555,370,144,4433,280,3250,2139,1980,370,294,2155,1923,3108,4649,1669,1432],[0.3181818181818182,0.3370607028753994,0.571072319201995,0.3560229445506692,0.7366702937976061,0.3409090909090909,0.2061855670103093,0.2475129327497015,0.3722627737226277,0.3481481481481482,0.1366999035059505,0.8092841163310962,0.9427083333333334,0.350253807106599,0.3286694825765575,0.2045088566827697,0.6028708133971292,0.3145539906103286,0.2903811252268603,0.1772455089820359,0.7397959183673469,0.4154411764705883,0.5387541607227769,0.814595660749507,0.6285714285714286,0.6776103336921421,0.6848969289019773,0.2822765469824293,0.2532188841201717,0.4050632911392405,0.25,0.101010101010101,0.2985074626865671,0.5446640316205533,0.5266272189349113,0.5617021276595745,0.09770114942528736,0.339022498060512,0.367624810892587,0.5543175487465181,0.4509473684210527,0.3475643130815544,0.5632393084622384,0.4513987671882408,0.4326241134751773,0.776,0.3152439024390244,0.3520518358531318,0.3169781931464175,0.5766129032258065,0.2038735983690112,0.5699797160243407,0.6525096525096525,0.3825136612021858,0.5573770491803278,0.3842364532019704,0.4412371134020618,0.4987468671679198,0.4519774011299435,0.3057644110275689,0.4325396825396826,0.140625,0.07955689828801611,0.5168539325842697,0.188050930460333,0.4130072262367982,0.3803116147308782,0.7049608355091384,0.4027149321266968,0.2103960396039604,0.3198529411764706,0.4037267080745341,0.1014492753623188,0.358695652173913,0.3503086419753086,0.7013157894736842,0.2189542483660131,0.2336448598130841,0.6818181818181818,0.6468085106382979,0.5338345864661654,0.7540729247478666,0.4133627019089574,0.3947496353913466,0.2594594594594595,0.3891891891891892,0.3055555555555556,0.3584480036092939,0.5142857142857142,0.3076923076923077,0.3501636278634876,0.7772727272727272,0.3918918918918919,0.6360544217687075,0.1271461716937355,0.1606864274570983,0.2638352638352638,0.4902129490212949,0.2570401437986818,0.9594972067039106],[0.6320346320346321,0.6309904153354633,0.4049875311720698,0.6332695984703632,0.2448313384113167,0.625,0.7628865979381443,0.7373656983684839,0.6094890510948905,0.6222222222222222,0.8481826954004503,0.1616331096196868,0.04166666666666666,0.6243654822335025,0.6615628299894404,0.7938808373590982,0.3684210526315789,0.6713615023474179,0.6969147005444646,0.8077844311377246,0.2397959183673469,0.5711898395721925,0.442225392296719,0.1518737672583826,0.3402597402597403,0.3067814854682454,0.2965923432898612,0.6990068754774638,0.7396280400572246,0.5864978902953587,0.7303921568627451,0.8855218855218855,0.6940298507462687,0.4442687747035573,0.4437869822485207,0.4212765957446808,0.8908045977011494,0.6431342125678821,0.6263237518910741,0.4178272980501393,0.5322105263157895,0.6360153256704981,0.4158325750682438,0.5320056899004267,0.5531914893617021,0.192,0.6673780487804878,0.6285097192224622,0.6748442367601246,0.4122983870967742,0.7854230377166157,0.3610547667342799,0.3366795366795367,0.5792349726775956,0.4262295081967213,0.5862068965517241,0.5257731958762887,0.4461152882205514,0.5329566854990584,0.6791979949874687,0.5634920634920635,0.8448660714285714,0.9164149043303121,0.4646067415730337,0.8001958863858962,0.5764313507504168,0.6090651558073654,0.2637075718015666,0.5610859728506787,0.7821782178217822,0.6470588235294118,0.5652173913043478,0.8804347826086957,0.6086956521739131,0.6296296296296297,0.2868421052631579,0.7668845315904139,0.7383177570093458,0.306060606060606,0.3347517730496454,0.4511278195488722,0.2238169123351435,0.580029368575624,0.5887214389888187,0.7261261261261261,0.5864864864864865,0.6458333333333334,0.6336566659147305,0.4357142857142857,0.6843076923076923,0.6358111266947172,0.2065656565656566,0.5783783783783784,0.3639455782312925,0.8607888631090487,0.8231929277171087,0.722972972972973,0.492794149279415,0.7297783103654883,0.03072625698324022],[455,621,1976,2598,911,175,292,2491,270,271,3096,1761,189,198,3743,602,209,212,544,3318,193,2975,2082,1011,383,1851,2356,2589,688,236,202,294,133,1254,171,228,345,1280,5236,350,2351,1801,1089,2101,137,126,3235,463,2545,987,1943,485,1286,354,181,403,482,395,526,1201,247,1778,984,1768,1021,1743,1401,379,441,405,268,161,270,369,634,752,909,425,321,1400,389,2559,1351,2043,549,368,143,4382,278,3211,2119,1956,364,290,2129,1912,3068,4598,1651,1420],[0.3098901098901099,0.3075684380032206,0.5273279352226721,0.3498845265588915,0.7178924259055982,0.3371428571428571,0.1849315068493151,0.2316338819751104,0.3888888888888889,0.3284132841328413,0.1579457364341085,0.7705848949460534,0.9312169312169312,0.3131313131313131,0.3224686080683943,0.2408637873754153,0.5071770334928229,0.330188679245283,0.2941176470588235,0.1720916214587101,0.6943005181347151,0.4094117647058824,0.5081652257444764,0.76162215628091,0.6240208877284595,0.6477579686655862,0.6735993208828522,0.2877558903051371,0.2601744186046512,0.4110169491525424,0.2821782178217822,0.119047619047619,0.3007518796992481,0.5661881977671451,0.5087719298245614,0.5482456140350878,0.1217391304347826,0.32109375,0.3609625668449198,0.5171428571428571,0.4325818800510421,0.3486951693503609,0.5436179981634527,0.4036173250832937,0.4598540145985401,0.7698412698412699,0.3174652241112829,0.3239740820734341,0.3115913555992141,0.4721377912867274,0.215645908389089,0.534020618556701,0.6423017107309487,0.3644067796610169,0.5303867403314917,0.3399503722084367,0.454356846473029,0.4481012658227848,0.4733840304182509,0.3089092422980849,0.4574898785425101,0.1428571428571428,0.100609756097561,0.5118778280542986,0.1802154750244858,0.4239816408491107,0.3668807994289793,0.6517150395778364,0.4081632653061225,0.2320987654320988,0.3283582089552239,0.3850931677018634,0.1592592592592593,0.2655826558265583,0.3880126182965299,0.6795212765957447,0.2189218921892189,0.2,0.6728971962616822,0.5842857142857143,0.5347043701799485,0.7018366549433372,0.4167283493708364,0.3798335780714635,0.2622950819672131,0.3804347826086957,0.3356643356643357,0.3461889548151529,0.4568345323741007,0.3086265960759888,0.3289287399716848,0.7443762781186094,0.3324175824175824,0.6068965517241379,0.1202442461249413,0.1610878661087866,0.2672750977835723,0.4734667246628969,0.2465172622652938,0.9464788732394366],[0.6175824175824176,0.6264090177133655,0.3917004048582996,0.6158583525789069,0.2447859495060373,0.6285714285714286,0.75,0.7205941389000401,0.5666666666666667,0.6457564575645757,0.8000645994832042,0.1584327086882453,0.02116402116402116,0.6161616161616161,0.6321132781191557,0.7225913621262459,0.4066985645933014,0.6320754716981132,0.6213235294117647,0.7802893309222423,0.2538860103626943,0.547563025210084,0.4404418828049952,0.1552917903066271,0.3394255874673629,0.3079416531604538,0.2775891341256367,0.6431054461181923,0.7063953488372093,0.5550847457627118,0.6534653465346535,0.826530612244898,0.6616541353383458,0.39792663476874,0.456140350877193,0.4473684210526316,0.855072463768116,0.6375,0.6044690603514133,0.4171428571428571,0.5133985538068907,0.6007773459189339,0.3829201101928374,0.5678248453117563,0.4817518248175183,0.1904761904761905,0.61854714064915,0.6241900647948164,0.6243614931237721,0.5055724417426545,0.7323726196603191,0.3649484536082474,0.3234836702954899,0.5310734463276836,0.4143646408839779,0.5880893300248139,0.5,0.4708860759493671,0.4866920152091255,0.6486261448792673,0.4696356275303644,0.8093363329583803,0.8658536585365854,0.4389140271493213,0.7825661116552399,0.5306942053930006,0.6052819414703783,0.287598944591029,0.5034013605442177,0.7308641975308642,0.6007462686567164,0.577639751552795,0.7925925925925926,0.6964769647696477,0.555205047318612,0.2659574468085106,0.7337733773377337,0.7576470588235295,0.2897196261682243,0.3692857142857143,0.4138817480719794,0.255177803829621,0.53960029607698,0.5849241311796378,0.7158469945355191,0.5842391304347826,0.5734265734265734,0.6168416248288453,0.4064748201438849,0.6568047337278107,0.6314299197734781,0.1932515337423313,0.6071428571428571,0.3517241379310345,0.8496946923438234,0.7923640167364017,0.6942633637548892,0.4826011309264898,0.7135069654754694,0.02676056338028169],[460,622,1988,2610,911,176,294,2504,273,270,3106,1761,192,196,3757,622,210,212,546,3322,194,2984,2083,1017,387,1853,2365,2605,695,237,203,298,134,1264,172,226,345,1280,5261,353,2369,1808,1095,2110,139,125,3259,458,2562,991,1957,485,1289,360,182,402,484,401,526,1208,251,1791,987,1778,1022,1771,1410,381,441,405,269,158,273,370,640,756,918,428,323,1405,399,2569,1360,2052,554,370,142,4404,278,3236,2136,1972,365,290,2146,1923,3094,4633,1657,1429],[0.3978260869565217,0.3922829581993569,0.5829979879275654,0.3781609195402299,0.7683863885839737,0.3977272727272727,0.2448979591836735,0.2759584664536741,0.4505494505494506,0.4111111111111111,0.1838377334191887,0.817717206132879,0.9270833333333334,0.3826530612244898,0.3540058557359596,0.2556270096463023,0.580952380952381,0.3584905660377358,0.3534798534798535,0.2155328115593016,0.7268041237113402,0.4547587131367292,0.556409025444071,0.816125860373648,0.6795865633074936,0.6961683756071236,0.7128964059196617,0.3201535508637236,0.2964028776978417,0.4388185654008439,0.3054187192118227,0.151006711409396,0.3283582089552239,0.5886075949367089,0.5465116279069767,0.6858407079646017,0.1333333333333333,0.35859375,0.4092377874928721,0.5410764872521246,0.4774166314900802,0.3838495575221239,0.5945205479452055,0.4568720379146919,0.4676258992805755,0.824,0.3562442467014422,0.3602620087336245,0.3645589383294301,0.5721493440968718,0.2519161982626469,0.5793814432989691,0.6757176105508146,0.4138888888888889,0.5824175824175825,0.4278606965174129,0.487603305785124,0.5561097256857855,0.4904942965779467,0.3352649006622517,0.5976095617529881,0.1697375767727526,0.1094224924012158,0.5556805399325084,0.2113502935420744,0.5143986448334275,0.4014184397163121,0.7165354330708661,0.4693877551020408,0.2814814814814815,0.3903345724907063,0.4620253164556962,0.1648351648351648,0.4081081081081081,0.428125,0.7129629629629629,0.2668845315904139,0.2803738317757009,0.7337461300309598,0.6505338078291815,0.5714285714285714,0.7481510315297781,0.4433823529411764,0.4249512670565302,0.2888086642599278,0.4243243243243243,0.3802816901408451,0.4003178928247048,0.5215827338129496,0.334672435105068,0.3609550561797753,0.7925963488843814,0.4246575342465753,0.6344827586206897,0.1444547996272134,0.2043681747269891,0.3225597931480285,0.5180228793438377,0.2776101388050694,0.960111966410077],[0.5804347826086956,0.5932475884244373,0.3888329979879276,0.614176245210728,0.2151481888035126,0.5511363636363636,0.7278911564625851,0.7064696485623003,0.5384615384615384,0.5703703703703704,0.8068254990341275,0.1567291311754685,0.04166666666666666,0.5816326530612245,0.631354804365185,0.7363344051446945,0.3809523809523809,0.6367924528301887,0.6263736263736264,0.7730282962071041,0.2268041237113402,0.5315013404825737,0.4229476716274604,0.1514257620452311,0.3074935400516796,0.2908796546141392,0.2630021141649049,0.6579654510556622,0.6935251798561151,0.5527426160337553,0.6600985221674877,0.8322147651006712,0.6716417910447762,0.3995253164556962,0.4302325581395349,0.3097345132743363,0.8579710144927536,0.621875,0.5803079262497624,0.4164305949008499,0.5031658927817645,0.5995575221238938,0.3799086757990868,0.5303317535545023,0.5035971223021583,0.152,0.6213562442467014,0.6222707423580786,0.6272443403590945,0.4228052472250252,0.7393970362800204,0.3670103092783505,0.3134212567882079,0.5277777777777778,0.4065934065934066,0.5348258706467661,0.4958677685950413,0.4164588528678304,0.5,0.6473509933774835,0.3904382470119522,0.8179787828029034,0.8794326241134752,0.4274465691788527,0.7798434442270059,0.4743083003952569,0.5886524822695035,0.2519685039370079,0.4807256235827664,0.7111111111111111,0.5799256505576208,0.5316455696202531,0.8278388278388278,0.581081081081081,0.5515625,0.2619047619047619,0.7167755991285403,0.6985981308411215,0.2414860681114551,0.3359430604982206,0.4160401002506265,0.2331646555079798,0.5433823529411764,0.5653021442495126,0.7003610108303249,0.5648648648648649,0.5774647887323944,0.5899182561307902,0.4064748201438849,0.6551297898640297,0.6217228464419475,0.1754563894523327,0.547945205479452,0.3482758620689655,0.8466915191053123,0.7852314092563702,0.6690368455074337,0.4644938484783078,0.7109233554616777,0.02589223233030091],[457,605,1960,2559,904,173,289,2483,269,261,3096,1646,185,190,3589,578,207,211,533,3271,190,2969,1390,1000,382,1447,2329,2564,683,231,201,294,134,1234,169,224,342,1276,5206,352,2326,1764,1086,2100,134,122,3189,458,2534,674,1936,482,1276,352,177,393,472,391,511,1193,241,1755,972,1750,1006,1759,1396,370,431,405,259,156,271,364,631,749,901,415,315,1087,391,2176,1337,2030,551,363,142,4357,270,3188,2106,1950,362,288,2120,1908,2974,4438,1642,1394],[0.3413566739606127,0.3355371900826447,0.548469387755102,0.3368503321610004,0.7334070796460177,0.3815028901734104,0.2214532871972318,0.2384212645992751,0.3903345724907063,0.3601532567049808,0.1401808785529716,1,0.9621621621621622,0.4157894736842105,0.3304541655057119,0.2024221453287197,0.6183574879227053,0.3554502369668247,0.3095684803001876,0.1742586365025986,0.7368421052631579,0.4078814415628157,1,0.8179999999999999,0.6151832460732984,1,0.712322885358523,0.2905616224648986,0.2547584187408492,0.4025974025974026,0.2338308457711443,0.1292517006802721,0.2985074626865671,0.5818476499189628,0.5976331360946746,0.6428571428571429,0.1023391812865497,0.3221003134796238,0.3520937379946216,0.5255681818181818,0.4591573516766982,0.3424036281179138,0.5874769797421732,0.4138095238095238,0.4552238805970149,0.819672131147541,0.3116964565694575,0.3427947598253275,0.3208366219415943,1,0.2071280991735537,0.5643153526970954,0.646551724137931,0.4147727272727273,0.5819209039548022,0.361323155216285,0.4682203389830508,0.5242966751918159,0.4696673189823874,0.3093042749371333,0.4522821576763486,0.1504273504273504,0.09259259259259259,0.5222857142857142,0.1858846918489065,0.4360432063672541,0.3775071633237823,0.7081081081081081,0.4454756380510441,0.1802469135802469,0.3359073359073359,0.4294871794871795,0.1365313653136531,0.3104395604395604,0.3518225039619651,0.7022696929238985,0.2375138734739179,0.2240963855421687,0.6984126984126984,1,0.5294117647058824,1,0.4255796559461481,0.3788177339901478,0.2595281306715064,0.3966942148760331,0.3309859154929577,0.3426669726876291,0.5703703703703704,0.2882685069008783,0.335707502374169,0.7979487179487179,0.3701657458563536,0.6354166666666666,0.1245283018867925,0.1540880503144654,0.2673167451244116,0.4864803965750338,0.2673568818514007,0.9691535150645624],[0.6017505470459519,0.6264462809917355,0.3908163265306123,0.6631496678389996,0.2367256637168142,0.6184971098265896,0.7785467128027682,0.7333870318163512,0.6096654275092936,0.6398467432950191,0.8598191214470284,0,0.03783783783783784,0.5842105263157895,0.6536639732516021,0.7975778546712803,0.3816425120772947,0.6445497630331753,0.6904315196998124,0.8257413634974015,0.2631578947368421,0.5581003704951162,0,0.174,0.3429319371727749,0,0.287677114641477,0.7086583463338534,0.7452415812591509,0.5974025974025974,0.7213930348258707,0.826530612244898,0.7014925373134329,0.4181523500810373,0.4023668639053254,0.3571428571428572,0.8976608187134503,0.6496865203761756,0.6473300038417211,0.4176136363636364,0.5408426483233018,0.6383219954648526,0.4125230202578269,0.5861904761904762,0.5447761194029851,0.180327868852459,0.6857949200376293,0.6572052401746725,0.6586424625098658,0,0.7732438016528925,0.3630705394190871,0.3526645768025078,0.5852272727272727,0.4180790960451977,0.5928753180661578,0.5317796610169492,0.4757033248081842,0.5303326810176126,0.6647108130762783,0.5477178423236515,0.8495726495726496,0.9074074074074074,0.4777142857142857,0.8021868787276342,0.5639567936327459,0.6224928366762178,0.2918918918918919,0.4965197215777262,0.817283950617284,0.6640926640926641,0.5705128205128205,0.8228782287822878,0.6703296703296703,0.5974643423137876,0.2977303070761015,0.7624861265260822,0.7759036144578313,0.3015873015873016,0,0.4705882352941176,0,0.5482423335826477,0.5911330049261084,0.7404718693284936,0.6033057851239669,0.6690140845070423,0.6559559329814092,0.4296296296296296,0.7117314930991218,0.664292497625831,0.2020512820512821,0.585635359116022,0.3645833333333333,0.8754716981132076,0.8459119496855346,0.7326832548755884,0.5013519603424966,0.7326431181485993,0.03084648493543759],[2319,2363,2460,1498,1808,178,966,793,736,919,1361,466,885,964,1101,1652,890,9,638,2582,2127,556,515,237,1813,456,1461,104,1643,843,2079,2130,208,1123,171,1001,1738,788,1868,1818,712,2564,1430,447,1895,1254,1857,1720,1763,337,1978,2335,2548,1731,2118,2358,831,1304,1644,2030,2646,2588,1529,2013,2577,2653,101,1300,2313,651,1007,1018,2072,2177,555,1367,2519,1003,925,375,60,364,1548,2575,97,175,985,1863,918,617,2430,1468,2247,1904,2399,1327,20,1077,2415,1186],["16-07","20-11","WHCH","FAIRFIELD HARBOUR","HAW CREEK ELEMENTARY SCHOOL","COLES STORE","OR2","SOUTH MILLS RIVER","ALLENDALE","G32","SILVER HILL 52","141","G05","H26","DALLAS  1","Atlantic/Sea Level/Cedar Island","G11","MINERAL SPRINGS  2","C1","BRADSHAW","11","MARS HILL","235","W25","BLACK MOUNTAIN 3 - LAKE TOMAHAWK","128","CROSS CREEK 21","CAPE FEAR","ANDERSON","HOBGOOD","FAIRPLAINS","BEAVER DAM","CREEKSVILLE","SANDY CREEK","ST JOHN","G40A2","07-00","PISGAH VIEW","LONGWOOD","FAIRVIEW VOLUNTEER FIRE DEPT","STATESVILLE  4","FOREST CITY  2","CROSS CREEK 30-G4","113","ELIZABETHTOWN  2","LAKEWOOD SCHOOL","TOWNCREEK","02-05","SILVER CREEK 01","001","ELLENDALE","18-01","HARRELLS","12-04","21","20-04","STEWARTS CREEK","0035.3","LEASBURG","JACKS CREEK","LUMBERTON  7","ROCK GROVE","WILLIAMS 2","EAST GRAHAM","DUNCAN CREEK-GOLDEN VALLEY","NORTH PEMBROKE","PARKVILLE","HOPE VALLEY BAPTIST","16-01","BENTONVILLE","H24","FR5B","ANTIOCH","01-29","HOT SPRINGS","THOMASVILLE 3 64","RICHFIELD","NCGR1","H01","021","AYDEN B","015","LAWNDL","CHIMNEY ROCK","BELVIDERE","WHITE CROSS","H20B","SHINGLETREE 1","G65","FALLING CREEK","STALLINGS VFD","MONTIBELLO","04-10","WINDSOR 1","BETHLEHEM PRESBYTERIAN CHURCH","CLARKSVILLE","ASHEBORO SOUTH","ASHBROOK","CROSSROADS AME ZION CHURCH","FORSYTH TECH CC MAZIE WOODRUFF CTR"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[92,92,87,25,11,68,41,45,47,41,29,60,41,41,36,16,41,77,53,80,96,57,60,65,11,60,26,71,17,42,97,95,66,35,68,41,13,45,10,11,49,81,26,60,9,32,10,13,12,60,2,92,82,13,96,92,43,32,17,100,78,80,24,1,81,78,72,32,92,51,41,41,97,92,57,29,84,41,41,60,74,60,23,81,72,68,41,10,41,54,90,26,92,8,90,30,76,36,90,34],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>County<\/th>\n      <th>Precinct<\/th>\n      <th>total_vote_pres<\/th>\n      <th>dem_share_pres<\/th>\n      <th>gop_share_pres<\/th>\n      <th>total_vote_senate<\/th>\n      <th>dem_share_senate<\/th>\n      <th>gop_share_senate<\/th>\n      <th>total_vote_gov<\/th>\n      <th>dem_share_gov<\/th>\n      <th>gop_share_gov<\/th>\n      <th>total_vote_house<\/th>\n      <th>dem_share_house<\/th>\n      <th>gop_share_house<\/th>\n      <th>id<\/th>\n      <th>enr_desc<\/th>\n      <th>of_prec_id<\/th>\n      <th>county_id<\/th>\n      <th>blockid<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"autoWidth":true,"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12,13,14,17]},{"name":"County","targets":0},{"name":"Precinct","targets":1},{"name":"total_vote_pres","targets":2},{"name":"dem_share_pres","targets":3},{"name":"gop_share_pres","targets":4},{"name":"total_vote_senate","targets":5},{"name":"dem_share_senate","targets":6},{"name":"gop_share_senate","targets":7},{"name":"total_vote_gov","targets":8},{"name":"dem_share_gov","targets":9},{"name":"gop_share_gov","targets":10},{"name":"total_vote_house","targets":11},{"name":"dem_share_house","targets":12},{"name":"gop_share_house","targets":13},{"name":"id","targets":14},{"name":"enr_desc","targets":15},{"name":"of_prec_id","targets":16},{"name":"county_id","targets":17},{"name":"blockid","targets":18}],"order":[],"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="add-some-geographic-features" class="level2">
<h2 class="anchored" data-anchor-id="add-some-geographic-features">Add some geographic features</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>geometry <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="st">"+init=epsg:4326"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_coordinates</span>() <span class="ot">-&gt;</span> latlong</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in CPL_crs_from_input(x): GDAL Message 1: +init=epsg:XXXX syntax is
deprecated. It might return a CRS with a non-EPSG compliant axis order. Further
messages of this type will be suppressed.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>longitude <span class="ot">=</span> latlong[, <span class="st">'X'</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>latitude <span class="ot">=</span> latlong[, <span class="st">'Y'</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>area <span class="ot">=</span> df_joined<span class="sc">$</span>geometry <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(<span class="st">"+init=epsg:4326"</span>) <span class="sc">%&gt;%</span> <span class="fu">st_area</span>()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>area_km2 <span class="ot">=</span> units<span class="sc">::</span><span class="fu">drop_units</span>(area) <span class="sc">/</span> <span class="fl">1e6</span> <span class="co"># convert m^2 to km^2</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>df_joined <span class="ot">&lt;-</span> df_joined <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">vote_density_pres =</span> total_vote_pres <span class="sc">/</span> area_km2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="assign-treatment-four-ways" class="level1">
<h1>Assign treatment four ways</h1>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Softblock</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Greedy nearest neighbors</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">QuickBlock</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Matched Pairs</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">=</span> lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">assign_softblock</span>(<span class="fu">c</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    longitude, latitude, area_km2, vote_density_pres, <span class="co"># geographic</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    total_vote_pres, dem_share_pres, gop_share_pres, <span class="co"># 2020 presidential</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    total_vote_senate, dem_share_senate, gop_share_senate, <span class="co"># 2020 senate</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    total_vote_gov, dem_share_gov, gop_share_gov, <span class="co"># 2020 governor</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    total_vote_house, dem_share_house, gop_share_house <span class="co"># 2020 house</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(<span class="at">treatment_sb=</span>treatment)<span class="ot">-&gt;</span> df_joined</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `normalized` argument of `make_lattice()` provide normalization instead as
of igraph 2.0.3.
ℹ `normalized` is now deprecated, use `normalization` instead.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>softblock_weights <span class="ot">&lt;-</span> <span class="fu">attr</span>(df_joined, <span class="st">"laplacian"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">=</span> lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(end_time <span class="sc">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.7473469 secs</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">=</span> lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">assign_greedy_neighbors</span>(<span class="fu">c</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    longitude, latitude, area_km2, vote_density_pres, <span class="co"># geographic</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    total_vote_pres, dem_share_pres, gop_share_pres, <span class="co"># 2020 presidential</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    total_vote_senate, dem_share_senate, gop_share_senate, <span class="co"># 2020 senate</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    total_vote_gov, dem_share_gov, gop_share_gov, <span class="co"># 2020 governor</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    total_vote_house, dem_share_house, gop_share_house <span class="co"># 2020 house</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(<span class="at">treatment_nn=</span>treatment)<span class="ot">-&gt;</span> df_joined</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>nn_weights <span class="ot">&lt;-</span> <span class="fu">attr</span>(df_joined, <span class="st">"laplacian"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">=</span> lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(end_time <span class="sc">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 1.482411 secs</code></pre>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">=</span> lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    longitude, latitude, area_km2, vote_density_pres, <span class="co"># geographic</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    total_vote_pres, dem_share_pres, gop_share_pres, <span class="co"># 2020 presidential</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    total_vote_senate, dem_share_senate, gop_share_senate, <span class="co"># 2020 senate</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    total_vote_gov, dem_share_gov, gop_share_gov, <span class="co"># 2020 governor</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    total_vote_house, dem_share_house, gop_share_house <span class="co"># 2020 house</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> df_qb</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>qb_blocks <span class="ot">=</span> <span class="fu">quickblock</span>(<span class="fu">as.data.frame</span>(df_qb), <span class="at">size_constraint =</span> <span class="dv">6</span>L)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>treatment_qb <span class="ot">=</span> <span class="fu">as.integer</span>(<span class="fu">as.character</span>(<span class="fu">assign_treatment</span>(qb_blocks, <span class="at">treatments=</span><span class="fu">c</span>(<span class="st">'0'</span>, <span class="st">'1'</span>))))</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">=</span> lubridate<span class="sc">::</span><span class="fu">now</span>()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(end_time <span class="sc">-</span> start_time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.03046703 secs</code></pre>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is extremely slow.</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># start_time = lubridate::now()</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># df_joined %&gt;% assign_matched_pairs(c(</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     longitude, latitude, area_km2, vote_density_pres, # geographic</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     total_vote_pres, dem_share_pres, gop_share_pres, # 2020 presidential</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     total_vote_house, dem_share_house, gop_share_house # 2020 house</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># )) %&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># rename(treatment_mp=treatment)-&gt; df_joined</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># mp_weights &lt;- attr(df_joined, "laplacian")</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># end_time = lubridate::now()</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># print(end_time - start_time)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="power-simulation" class="level1">
<h1>Power simulation</h1>
<p>To do power calculations consistently across methods, I will do the following:</p>
<ol type="1">
<li>Calculate the implied regression adjustment for each design, applied to vote share in 2020 as the outcome.</li>
<li>Find the residual for each point.</li>
<li>Permute residuals over units.</li>
<li>Estimate power for a given effect size by pulling additional permutations.</li>
<li>Sweep over a range of effect sizes.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>create_power_simulator <span class="ot">=</span> <span class="cf">function</span>(W, A, Y) {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    dL <span class="ot">=</span> <span class="fu">diag</span>(W)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    Dinv <span class="ot">=</span> (<span class="dv">2</span> <span class="sc">*</span> A <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> dL</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    estimates <span class="ot">=</span> <span class="fu">drop</span>((Dinv <span class="sc">%*%</span> W) <span class="sc">%*%</span> Y)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">=</span> Y <span class="sc">-</span> estimates</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    x_mat <span class="ot">=</span> <span class="fu">cbind</span>(A, <span class="dv">1</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    xlx <span class="ot">=</span> <span class="fu">t</span>(x_mat) <span class="sc">%*%</span> W <span class="sc">%*%</span> x_mat</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    bread <span class="ot">=</span> MASS<span class="sc">::</span><span class="fu">ginv</span>(<span class="fu">as.matrix</span>(xlx))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    detect_effect <span class="ot">=</span> <span class="cf">function</span>(<span class="at">effect=</span><span class="dv">1</span>) {</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        sim_outcome <span class="ot">=</span> estimates <span class="sc">+</span> <span class="fu">sample</span>(residuals) <span class="sc">+</span> A <span class="sc">*</span> effect</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        coefs <span class="ot">=</span> bread <span class="sc">%*%</span> <span class="fu">t</span>(x_mat) <span class="sc">%*%</span> W <span class="sc">%*%</span> sim_outcome</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        r <span class="ot">=</span> <span class="fu">diag</span>(<span class="fu">drop</span>((sim_outcome <span class="sc">-</span> (x_mat <span class="sc">%*%</span> coefs)) <span class="sc">^</span> <span class="dv">2</span>))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        meat <span class="ot">=</span> <span class="fu">t</span>(x_mat) <span class="sc">%*%</span> (W <span class="sc">%*%</span> r <span class="sc">%*%</span> W) <span class="sc">%*%</span> x_mat</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        vcv <span class="ot">=</span> bread <span class="sc">%*%</span> meat <span class="sc">%*%</span> bread</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        upr <span class="ot">=</span> coefs[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(vcv[<span class="dv">1</span>])</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        lwr <span class="ot">=</span> coefs[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.025</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(vcv[<span class="dv">1</span>])</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        lwr <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    detect_effect</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>create_power_simulator_qb <span class="ot">=</span> <span class="cf">function</span>(blocks, A, Y) {</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    estimate_by_block <span class="ot">=</span> <span class="fu">tapply</span>(Y[A<span class="sc">==</span><span class="dv">1</span>], blocks[A<span class="sc">==</span><span class="dv">1</span>], mean) <span class="sc">-</span> <span class="fu">tapply</span>(Y[A<span class="sc">==</span><span class="dv">0</span>], blocks[A<span class="sc">==</span><span class="dv">0</span>], mean)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    estimates <span class="ot">=</span> <span class="fu">unlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(blocks, <span class="cf">function</span>(b) estimate_by_block[<span class="fu">as.character</span>(b)]))</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">=</span> Y <span class="sc">-</span> estimates</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    detect_effect <span class="ot">=</span> <span class="cf">function</span>(<span class="at">effect=</span><span class="dv">1</span>) {</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        sim_outcome <span class="ot">=</span> estimates <span class="sc">+</span> <span class="fu">sample</span>(residuals) <span class="sc">+</span> A <span class="sc">*</span> effect</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">=</span> quickblock<span class="sc">::</span><span class="fu">blocking_estimator</span>(sim_outcome, blocks, A)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        upr <span class="ot">=</span> result<span class="sc">$</span>effects[<span class="dv">2</span>,<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(result<span class="sc">$</span>effect_variances[<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        lwr <span class="ot">=</span> result<span class="sc">$</span>effects[<span class="dv">2</span>,<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">qnorm</span>(<span class="fl">0.025</span>) <span class="sc">*</span> <span class="fu">sqrt</span>(result<span class="sc">$</span>effect_variances[<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        lwr <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    detect_effect</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="simulate-each-design" class="level2">
<h2 class="anchored" data-anchor-id="simulate-each-design">Simulate each design</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Softblock</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Greedy Neighbors</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">QuickBlock</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>simulate_power <span class="ot">=</span> <span class="fu">create_power_simulator</span>(softblock_weights, df_joined<span class="sc">$</span>treatment_sb, df_joined<span class="sc">$</span>dem_share_pres)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>estimate_power_for_effect <span class="ot">=</span> <span class="cf">function</span>(effect) <span class="fu">mean</span>(<span class="fu">replicate</span>(<span class="dv">25</span>, <span class="fu">simulate_power</span>(<span class="at">effect=</span>effect)))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>effects <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="at">length=</span><span class="dv">25</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>power_sb <span class="ot">=</span> <span class="fu">unlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(effects, estimate_power_for_effect))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>simulate_power <span class="ot">=</span> <span class="fu">create_power_simulator</span>(nn_weights, df_joined<span class="sc">$</span>treatment_nn, df_joined<span class="sc">$</span>dem_share_pres)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>estimate_power_for_effect <span class="ot">=</span> <span class="cf">function</span>(effect) <span class="fu">mean</span>(<span class="fu">replicate</span>(<span class="dv">25</span>, <span class="fu">simulate_power</span>(<span class="at">effect=</span>effect)))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>power_nn <span class="ot">=</span> <span class="fu">unlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(effects, estimate_power_for_effect))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>simulate_power <span class="ot">=</span> <span class="fu">create_power_simulator_qb</span>(qb_blocks, df_joined<span class="sc">$</span>treatment_qb, df_joined<span class="sc">$</span>dem_share_pres)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>estimate_power_for_effect <span class="ot">=</span> <span class="cf">function</span>(effect) <span class="fu">mean</span>(<span class="fu">replicate</span>(<span class="dv">25</span>, <span class="fu">simulate_power</span>(<span class="at">effect=</span>effect)))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>effects <span class="ot">=</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="at">length=</span><span class="dv">25</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>power_qb <span class="ot">=</span> <span class="fu">unlist</span>(purrr<span class="sc">::</span><span class="fu">map</span>(effects, estimate_power_for_effect))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="power-comparison" class="level2">
<h2 class="anchored" data-anchor-id="power-comparison">Power Comparison</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">effects=</span><span class="fu">c</span>(effects, effects, effects),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">power=</span><span class="fu">c</span>(power_sb, power_nn, power_qb),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">design=</span><span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">'SoftBlock'</span>, <span class="fu">length</span>(power_sb)), <span class="fu">rep</span>(<span class="st">'Greedy Neighbors'</span>, <span class="fu">length</span>(power_sb)), <span class="fu">rep</span>(<span class="st">'QuickBlock'</span>, <span class="fu">length</span>(power_sb)))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    ), <span class="fu">aes</span>(effects, power, <span class="at">color=</span>design)) <span class="sc">+</span> <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="st">'Effect (pp)'</span>, <span class="at">labels=</span>scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">"Power"</span>, <span class="at">labels=</span>scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_discrete</span>(<span class="st">"Design"</span>) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/power_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="analysis" class="level1">
<h1>Analysis</h1>
<section id="average-effects" class="level2">
<h2 class="anchored" data-anchor-id="average-effects">Average Effects</h2>
<p>The effect estimates here use the appropriate design-based estimators for each design.</p>
<p>First, I’m going to generate a fake outcome to use. I’ll leave the average effect near zero (0.5pp), but individual effects are random draws from around that vale, but with heterogeneous effects based on democratic vote share in 2020 (i.e.&nbsp;positive effects in democratic precincts and vice versa).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>outcome <span class="ot">=</span> df_joined<span class="sc">$</span>dem_share_pres</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>ite <span class="ot">=</span> <span class="fu">with</span>(df_joined, <span class="fl">0.005</span> <span class="sc">+</span> <span class="fl">0.005</span> <span class="sc">*</span> (<span class="fu">plogis</span>((dem_share_pres <span class="sc">-</span> <span class="fu">median</span>(dem_share_pres)) <span class="sc">/</span> <span class="fu">sd</span>(dem_share_pres))))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>outcome_sb <span class="ot">=</span> <span class="fu">with</span>(df_joined, outcome <span class="sc">+</span> treatment_sb <span class="sc">*</span> ite)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>outcome_nn <span class="ot">=</span> <span class="fu">with</span>(df_joined, outcome <span class="sc">+</span> treatment_nn <span class="sc">*</span> ite)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>df_joined<span class="sc">$</span>outcome_qb <span class="ot">=</span> <span class="fu">with</span>(df_joined, outcome <span class="sc">+</span> treatment_qb <span class="sc">*</span> ite)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Softblock</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Greedy Neighbors</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">QuickBlock</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>estimate_effect <span class="ot">=</span> <span class="cf">function</span>(W, A, Y) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    dL <span class="ot">=</span> <span class="fu">diag</span>(W)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    Dinv <span class="ot">=</span> (<span class="dv">2</span> <span class="sc">*</span> A <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> dL</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    x_mat <span class="ot">=</span> <span class="fu">cbind</span>(A, <span class="dv">1</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    xlx <span class="ot">=</span> <span class="fu">t</span>(x_mat) <span class="sc">%*%</span> W <span class="sc">%*%</span> x_mat</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    bread <span class="ot">=</span> MASS<span class="sc">::</span><span class="fu">ginv</span>(<span class="fu">as.matrix</span>(xlx))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    coefs <span class="ot">=</span> bread <span class="sc">%*%</span> <span class="fu">t</span>(x_mat) <span class="sc">%*%</span> W <span class="sc">%*%</span> Y</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">=</span> <span class="fu">diag</span>(<span class="fu">drop</span>((Y <span class="sc">-</span> (x_mat <span class="sc">%*%</span> coefs)) <span class="sc">^</span> <span class="dv">2</span>))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    meat <span class="ot">=</span> <span class="fu">t</span>(x_mat) <span class="sc">%*%</span> (W <span class="sc">%*%</span> r <span class="sc">%*%</span> W) <span class="sc">%*%</span> x_mat</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    vcv <span class="ot">=</span> bread <span class="sc">%*%</span> meat <span class="sc">%*%</span> bread</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">estimate=</span>coefs[<span class="dv">1</span>], <span class="at">std.error=</span><span class="fu">sqrt</span>(vcv[<span class="dv">1</span>,<span class="dv">1</span>]))</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>sb_est <span class="ot">=</span> <span class="fu">estimate_effect</span>(softblock_weights, df_joined<span class="sc">$</span>treatment_sb, df_joined<span class="sc">$</span>outcome_sb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>nn_est <span class="ot">=</span> <span class="fu">estimate_effect</span>(nn_weights, df_joined<span class="sc">$</span>treatment_nn, df_joined<span class="sc">$</span>outcome_nn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> quickblock<span class="sc">::</span><span class="fu">blocking_estimator</span>(df_joined<span class="sc">$</span>outcome_qb, qb_blocks, df_joined<span class="sc">$</span>treatment_qb)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>qb_est <span class="ot">=</span> <span class="fu">list</span>(<span class="at">estimate=</span>result<span class="sc">$</span>effects[<span class="dv">2</span>,<span class="dv">1</span>], <span class="at">std.error=</span><span class="fu">sqrt</span>(result<span class="sc">$</span>effect_variances[<span class="dv">2</span>,<span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="plot-average-effects" class="level2">
<h2 class="anchored" data-anchor-id="plot-average-effects">Plot Average Effects</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate=</span><span class="fu">c</span>(sb_est<span class="sc">$</span>estimate, nn_est<span class="sc">$</span>estimate, qb_est<span class="sc">$</span>estimate),</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">std.error=</span><span class="fu">c</span>(sb_est<span class="sc">$</span>std.error, nn_est<span class="sc">$</span>std.error, qb_est<span class="sc">$</span>std.error),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">design=</span><span class="fu">c</span>(<span class="st">"SoftBlock"</span>, <span class="st">"Greedy Neighbors"</span>, <span class="st">"QuickBlock"</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>design, <span class="at">y=</span>estimate, <span class="at">ymin=</span>estimate<span class="fl">-1.96</span><span class="sc">*</span>std.error, <span class="at">ymax=</span>estimate<span class="fl">+1.96</span><span class="sc">*</span>std.error)) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_pointrange</span>() <span class="sc">+</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="st">"Design"</span>) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="st">"ATE (pp)"</span>, <span class="at">labels=</span>scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot_fx-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="heterogeneous-effects" class="level2">
<h2 class="anchored" data-anchor-id="heterogeneous-effects">Heterogeneous Effects</h2>
<p>These effects will be estimated using DR-learner of <a href="https://arxiv.org/abs/2004.14497">Kennedy (2020)</a>. For simplicity, I will estimate nuisance functions using <code>glmnet</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>predict.hte.split <span class="ot">=</span> <span class="cf">function</span>(x, a, y, s, <span class="at">predict.s=</span><span class="dv">4</span>) {</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    s.pi <span class="ot">=</span> (predict.s) <span class="sc">%%</span> <span class="dv">4</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    s.mu <span class="ot">=</span> (predict.s <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%%</span> <span class="dv">4</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    s.dr <span class="ot">=</span> (predict.s <span class="sc">+</span> <span class="dv">2</span>) <span class="sc">%%</span> <span class="dv">4</span> <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    pihat <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">cv.glmnet</span>(x[s<span class="sc">==</span>s.pi,],a[s<span class="sc">==</span>s.pi], <span class="at">family=</span><span class="st">"binomial"</span>, <span class="at">nfolds=</span><span class="dv">10</span>), <span class="at">newx=</span>x, <span class="at">type=</span><span class="st">"response"</span>, <span class="at">s=</span><span class="st">"lambda.min"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    mu0hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">cv.glmnet</span>(x[a<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> s<span class="sc">==</span>s.mu,],y[a<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> s<span class="sc">==</span>s.mu], <span class="at">nfolds=</span><span class="dv">10</span>), <span class="at">newx=</span>x, <span class="at">type=</span><span class="st">"response"</span>, <span class="at">s=</span><span class="st">"lambda.min"</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    mu1hat <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">cv.glmnet</span>(x[a<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> s<span class="sc">==</span>s.mu,],y[a<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> s<span class="sc">==</span>s.mu], <span class="at">nfolds=</span><span class="dv">10</span>),<span class="at">newx=</span>x, <span class="at">type=</span><span class="st">"response"</span>, <span class="at">s=</span><span class="st">"lambda.min"</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    pseudo <span class="ot">&lt;-</span> ((a<span class="sc">-</span>pihat)<span class="sc">/</span>(pihat<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>pihat)))<span class="sc">*</span>(y<span class="sc">-</span>a<span class="sc">*</span>mu1hat<span class="sc">-</span>(<span class="dv">1</span><span class="sc">-</span>a)<span class="sc">*</span>mu0hat) <span class="sc">+</span> mu1hat <span class="sc">-</span> mu0hat</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    drl <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="fu">cv.glmnet</span>(x[s<span class="sc">==</span>s.dr,],pseudo[s<span class="sc">==</span>s.dr]),<span class="at">newx=</span>x[s<span class="sc">==</span>predict.s, ], <span class="at">s=</span><span class="st">"lambda.min"</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    drl</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>predict.hte.crossfit <span class="ot">=</span> <span class="cf">function</span>(x, a, y) {</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    N <span class="ot">=</span> <span class="fu">length</span>(a)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, N, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    hte <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, N)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (split <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        hte[s<span class="sc">==</span>split] <span class="ot">=</span> <span class="fu">predict.hte.split</span>(x, a, y, s, <span class="at">predict.s=</span>split)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    hte</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>calculate_hte <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, cols, <span class="at">.treatment=</span><span class="st">'treatment'</span>, <span class="at">.outcome=</span><span class="st">'outcome'</span>) {</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    expr <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">enquo</span>(cols)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> tidyselect<span class="sc">::</span><span class="fu">eval_select</span>(expr, <span class="at">data =</span> .data)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    df_cov <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">set_names</span>(.data[pos], <span class="fu">names</span>(pos))</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    cov_mat <span class="ot">=</span> <span class="fu">scale</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span>.<span class="sc">+</span><span class="dv">0</span>, df_cov))</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    .data<span class="sc">$</span>hte <span class="ot">=</span> <span class="fu">predict.hte.crossfit</span>(cov_mat, .data[[.treatment]], .data[[.outcome]])</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    .data</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="estimate-htes" class="level2">
<h2 class="anchored" data-anchor-id="estimate-htes">Estimate HTEs</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Softblock</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Greedy Neighbors</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">QuickBlock</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">calculate_hte</span>(<span class="fu">c</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    longitude, latitude, area_km2, vote_density_pres, <span class="co"># geographic</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    total_vote_pres, <span class="co"># 2020 presidential</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    total_vote_senate, dem_share_senate, gop_share_senate, <span class="co"># 2020 senate</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    total_vote_gov, dem_share_gov, gop_share_gov, <span class="co"># 2020 governor</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    total_vote_house, dem_share_house, gop_share_house <span class="co"># 2020 house</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>), <span class="at">.treatment=</span><span class="st">'treatment_sb'</span>, <span class="at">.outcome=</span><span class="st">'outcome_sb'</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">hte_sb=</span>hte) <span class="ot">-&gt;</span> df_joined</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df_joined<span class="sc">$</span>hte_sb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.010306  0.004135  0.007536  0.007148  0.009029  0.033580 </code></pre>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">calculate_hte</span>(<span class="fu">c</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    longitude, latitude, area_km2, vote_density_pres, <span class="co"># geographic</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    total_vote_pres, <span class="co"># 2020 presidential</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    total_vote_senate, dem_share_senate, gop_share_senate, <span class="co"># 2020 senate</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    total_vote_gov, dem_share_gov, gop_share_gov, <span class="co"># 2020 governor</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    total_vote_house, dem_share_house, gop_share_house <span class="co"># 2020 house</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>), <span class="at">.treatment=</span><span class="st">'treatment_nn'</span>, <span class="at">.outcome=</span><span class="st">'outcome_nn'</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">hte_nn=</span>hte) <span class="ot">-&gt;</span> df_joined</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df_joined<span class="sc">$</span>hte_nn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.005742 0.006825 0.007388 0.007670 0.008596 0.010863 </code></pre>
</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="sc">%&gt;%</span> <span class="fu">calculate_hte</span>(<span class="fu">c</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    longitude, latitude, area_km2, vote_density_pres, <span class="co"># geographic</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    total_vote_pres, <span class="co"># 2020 presidential</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    total_vote_senate, dem_share_senate, gop_share_senate, <span class="co"># 2020 senate</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    total_vote_gov, dem_share_gov, gop_share_gov, <span class="co"># 2020 governor</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    total_vote_house, dem_share_house, gop_share_house <span class="co"># 2020 house</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>), <span class="at">.treatment=</span><span class="st">'treatment_qb'</span>, <span class="at">.outcome=</span><span class="st">'outcome_qb'</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">hte_qb=</span>hte) <span class="ot">-&gt;</span> df_joined</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(df_joined<span class="sc">$</span>hte_qb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-0.0007862  0.0070832  0.0083612  0.0082249  0.0094074  0.0398552 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="plot-hte-distributions" class="level2">
<h2 class="anchored" data-anchor-id="plot-hte-distributions">Plot HTE distributions</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_joined, <span class="fu">aes</span>()) <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x=</span>hte_sb, <span class="at">fill=</span><span class="st">'SoftBlock'</span>), <span class="at">bins=</span><span class="dv">50</span>, <span class="at">alpha=</span><span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x=</span>hte_nn, <span class="at">fill=</span><span class="st">'Greedy Neighbors'</span>), <span class="at">bins=</span><span class="dv">50</span>, <span class="at">alpha=</span><span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x=</span>hte_qb, <span class="at">fill=</span><span class="st">'QuickBlock'</span>), <span class="at">bins=</span><span class="dv">50</span>, <span class="at">alpha=</span><span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_x_continuous</span>(<span class="st">"Effect (pp)"</span>, <span class="at">labels=</span>scales<span class="sc">::</span>percent) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/hte_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{dimmery2022,
  author = {Dimmery, Drew},
  title = {Using {SoftBlock} to {Design} an {Experiment}},
  date = {2022-05-10},
  url = {https://ddimmery.com/posts/softblock-demo},
  langid = {en},
  abstract = {This is a demo of using SoftBlock for experimental design
    for a notional randomization of precincts in North Carolina. To
    optimize power, we focus on ensuring very similar patterns of prior
    voting patterns in treatment and in control. This demo walks through
    all the necessary steps for this process and shows how to perform
    estimation of average and heterogeneous effects.}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-dimmery2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Dimmery, Drew. 2022. <span>“Using SoftBlock to Design an
Experiment.”</span> May 10, 2022. <a href="https://ddimmery.com/posts/softblock-demo">https://ddimmery.com/posts/softblock-demo</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ddimmery\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>