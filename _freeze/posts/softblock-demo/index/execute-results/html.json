{
  "hash": "44bbf8b0b6f9a985dfcc51e954d2e7a3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Using SoftBlock to Design an Experiment\"\ndescription: \"In this demo, I'm going to walk through an example experimental design using methods from our [recent paper on Balanced Design](https://arxiv.org/abs/2010.11332).\"\nabstract: >\n  This is a demo of using SoftBlock for experimental design for a notional randomization of precincts in North Carolina. To optimize power, we focus on ensuring very similar patterns of prior voting patterns in treatment and in control. This demo walks through all the necessary steps for this process and shows how to perform estimation of average and heterogeneous effects.\ndate: \"2022-05-10\"\ncategories:\n  - experiments\n  - demo\ncode-fold: true\nimage: main-image.png\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# Introduction\n\nIn particular, I'm going to imagine that I'm designing an experiment in which I assign different treatments to particular precincts in North Carolina. In order to optimize power, of course, we want to make sure that our two test groups look as similar as possible in terms of prior voting patterns.\n\nThus, the steps in this design will be:\n\n1. Collect relevant historical data.\n2. Define variables on which we wish to balance.\n3. Allocate treatment assignment using new methods.\n4. Simulate the power of hypothesis tests under the proposed design.\n5. Fake some outcome data and analyze it for average and heterogeneous treatment effects.\n\n# Implementation of methods\n\n## Description\n\nThe relevant API is a function with `tidyverse` semantics called `assign_softblock` (or `assign_greedy_neighbors`). These functions accept a vector of columns to be used in the design. The SoftBlock version additionally accepts two arguments, `.s2` for the bandwidth of the RBF kernel to use in the construction of a similarity matrix as well as `.neighbors` which indicates the number of nearest neighbors to include in the graph on which to construct the spanning tree. These parameters don't generally need to be modified.\n\n## Source Code\n<details><summary>See source code</summary>\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwriteLines(readLines(\"https://raw.githubusercontent.com/ddimmery/softblock/master/r_implementation.R\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nlibrary(Matrix)\nlibrary(igraph)\nlibrary(FNN)\nlibrary(hash)\n\nassign_greedily <- function(graph) {\n    adj_mat = igraph::as_adjacency_matrix(graph, type=\"both\", sparse=TRUE) != 0\n    N = nrow(adj_mat)\n    root_id = make.keys(sample(N, 1))\n\n    a = rbinom(1, 1, 0.5)\n    visited = hash()\n\n    random_order = make.keys(sample(N))\n    unvisited = hash(random_order, random_order)\n\n    colors = hash()\n    stack = hash()\n\n    stack[[root_id]] <- a\n    tentative_color = rbinom(N, 1, 0.5)\n    while ((!is.empty(unvisited)) || (!is.empty(stack))) {\n        if (is.empty(stack)) {\n            cur_node = keys(unvisited)[1]\n            del(cur_node, unvisited)\n            color = tentative_color[as.integer(cur_node)]\n        } else {\n            cur_node = keys(stack)[1]\n            color = stack[[cur_node]]\n            del(cur_node, stack)\n            del(cur_node, unvisited)\n        }\n        visited[[cur_node]] = cur_node\n        colors[[cur_node]] = color\n        children = make.keys(which(adj_mat[as.integer(cur_node), ]))\n        for (child in children) {\n            if(has.key(child, unvisited)) {\n                stack[[child]] = 1 - color\n            }\n        }\n    }\n    values(colors, keys=1:N)\n}\n\n\nassign_softblock <- function(.data, cols, .s2=2, .neighbors=6) {\n    expr <- rlang::enquo(cols)\n    pos <- tidyselect::eval_select(expr, data = .data)\n    df_cov <- rlang::set_names(.data[pos], names(pos))\n    cov_mat = scale(model.matrix(~.+0, df_cov))\n    N = nrow(cov_mat)\n    st = lubridate::now()\n    knn = FNN::get.knn(cov_mat, k=.neighbors)\n    st = lubridate::now()\n    knn.adj = Matrix::sparseMatrix(i=rep(1:N, .neighbors), j=c(knn$nn.index), x=exp(-c(knn$nn.dist) / .s2))\n    knn.graph <- graph_from_adjacency_matrix(knn.adj, mode=\"plus\", weighted=TRUE, diag=FALSE)\n    E(knn.graph)$weight <- (-1 * E(knn.graph)$weight)\n    st = lubridate::now()\n    mst.graph = igraph::mst(knn.graph)\n    E(mst.graph)$weight <- (-1 * E(mst.graph)$weight)\n    st = lubridate::now()\n    assignments <- assign_greedily(mst.graph)\n    .data$treatment <- assignments\n    attr(.data, \"laplacian\") <- igraph::laplacian_matrix(mst.graph, normalize=TRUE, sparse=TRUE)\n    .data\n}\n\nassign_greedy_neighbors <- function(.data, cols) {\n    expr <- rlang::enquo(cols)\n    pos <- tidyselect::eval_select(expr, data = .data)\n    df_cov <- rlang::set_names(.data[pos], names(pos))\n    cov_mat = scale(model.matrix(~.+0, df_cov))\n    N = nrow(cov_mat)\n    knn = FNN::get.knn(cov_mat, k=1)\n    knn.adj = Matrix::sparseMatrix(i=1:N, j=c(knn$nn.index), x=c(knn$nn.dist))\n    knn.graph <- graph_from_adjacency_matrix(knn.adj, mode=\"plus\", weighted=TRUE, diag=FALSE)\n    assignments <- assign_greedily(knn.graph)\n    .data$treatment <- assignments\n    attr(.data, \"laplacian\") <- igraph::laplacian_matrix(knn.graph, normalize=TRUE, sparse=TRUE)\n    .data\n}\n\nassign_matched_pairs <- function(.data, cols, .s2=2, .neighbors=6) {\n    expr <- rlang::enquo(cols)\n    pos <- tidyselect::eval_select(expr, data = .data)\n    df_cov <- rlang::set_names(.data[pos], names(pos))\n    cov_mat = scale(model.matrix(~.+0, df_cov))\n    N = nrow(cov_mat)\n    knn = FNN::get.knn(cov_mat, k=.neighbors)\n    knn.adj = Matrix::sparseMatrix(i=rep(1:N, .neighbors), j=c(knn$nn.index), x=exp(-c(knn$nn.dist) / .s2))\n    knn.graph <- graph_from_adjacency_matrix(knn.adj, mode=\"plus\", weighted=TRUE, diag=FALSE)\n    E(knn.graph)$weight <- (-1 * E(knn.graph)$weight)\n    mwm.graph = igraph::max_bipartite_match(knn.graph)\n    E(mwm.graph)$weight <- (-1 * E(mwm.graph)$weight)\n    assignments <- assign_greedily(mwm.graph)\n    .data$treatment <- assignments\n    attr(.data, \"laplacian\") <- igraph::laplacian_matrix(mwm.graph, normalize=TRUE, sparse=TRUE)\n    .data\n}\n\n# library(tibble)\n# data = tibble(\n#     x1=runif(10),\n#     x2=runif(10),\n#     x3=rbinom(10, 1, 0.5)\n# )\n# library(dplyr)\n# library(tidyr)\n# library(ggplot2)\n# data %>% assign_softblock(c(x1, x2)) -> newdata\n\n# ggplot(newdata, aes(x=x1, y=x2, color=factor(treatment), shape=factor(x3))) + geom_point() + theme_minimal()\n\n# newdata %>%\n#     attr(\"laplacian\") %>%\n#     ifelse(lower.tri(.), ., 0) %>%\n#     as_tibble() -> adj_df\n# names(adj_df) <- paste0(1:ncol(adj_df))\n\n# adj_df %>%\n#     group_by(id_1=as.character(row_number())) %>%\n#     gather(id_2, weight, -id_1) %>%\n#     filter(weight != 0)  %>%\n#     mutate(id_2=as.character(id_2), id=paste(id_1, id_2, sep='-')) -> adj_df\n\n# locs = newdata %>% mutate(id=as.character(row_number())) %>% select(id, x1, x2, x3)\n\n# edges=bind_rows(\n# adj_df  %>% inner_join(locs, by=c('id_1'='id')),\n# adj_df  %>% inner_join(locs, by=c('id_2'='id'))\n# ) %>% arrange(id) %>% ungroup()\n\n# pp = ggplot(newdata, aes(x=x1, y=x2)) +\n# geom_line(aes(group=id, size=1), data=edges, color='grey') +\n# geom_point(aes(color=factor(treatment), shape=factor(x3), size=2), alpha=.9) +\n# scale_size_continuous(range=c(1, 3)) +\n# theme_minimal() + theme(legend.position='none')\n\n# print(pp)\n```\n\n\n:::\n:::\n\n\n\n</details>\n\n# Data Preparation\n\nThis demo will be based on North Carolina data because their Board of Elections makes it very easy to get precinct level data. I'm also only going to use historical data from the most recent election to avoid needing to match precincts across elections.\n\nWith access to a full voter file, this section could be drastically improved by incorporating other important elements into the design like demographics.\n\n## Get Precinct data {.tabset}\n\n### Results Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"http://dl.ncsbe.gov/ENRS/2020_11_03/results_pct_20201103.zip\"\nzip_file <- tempfile(fileext = \".zip\")\ndownload.file(url, zip_file, mode = \"wb\")\nspec = cols(\n  County = col_character(),\n  `Election Date` = col_character(),\n  Precinct = col_character(),\n  `Contest Group ID` = col_double(),\n  `Contest Type` = col_character(),\n  `Contest Name` = col_character(),\n  Choice = col_character(),\n  `Choice Party` = col_character(),\n  `Vote For` = col_double(),\n  `Election Day` = col_double(),\n  `One Stop` = col_double(),\n  `Absentee by Mail` = col_double(),\n  Provisional = col_double(),\n  `Total Votes` = col_double(),\n  `Real Precinct` = col_character(),\n  X16 = col_skip()\n)\nresults <- readr::read_tsv(zip_file, col_types=spec)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nNew names:\n• `` -> `...16`\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The following named parsers don't match the column names: X16\n```\n\n\n:::\n:::\n\n\n\n\n### Shapefiles\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl = \"https://s3.amazonaws.com/dl.ncsbe.gov/ShapeFiles/Precinct/SBE_PRECINCTS_20201018.zip\"\ntemp <- tempfile()\ntemp2 <- tempfile()\ndownload.file(url, temp)\nunzip(zipfile = temp, exdir = temp2)\nnc_SHP_file <- list.files(temp2, pattern = \".shp$\",full.names=TRUE)\nshapes <- sf::read_sf(nc_SHP_file)\n```\n:::\n\n\n\n\n## Aggregate Data and Join\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresults %>%\n    filter(`Real Precinct` == 'Y') %>%\n    group_by(County, Precinct) %>%\n    summarize(\n        total_vote_pres=sum(`Total Votes`[`Contest Name` == 'US PRESIDENT'], na.rm=TRUE),\n        dem_share_pres=sum(`Total Votes`[`Contest Name` == 'US PRESIDENT' & `Choice Party` == 'DEM'], na.rm=TRUE)/total_vote_pres,\n        gop_share_pres=sum(`Total Votes`[`Contest Name` == 'US PRESIDENT' & `Choice Party` == 'REP'], na.rm=TRUE)/total_vote_pres,\n        total_vote_senate=sum(`Total Votes`[`Contest Name` == 'US SENATE'], na.rm=TRUE),\n        dem_share_senate=sum(`Total Votes`[`Contest Name` == 'US SENATE' & `Choice Party` == 'DEM'], na.rm=TRUE)/total_vote_senate,\n        gop_share_senate=sum(`Total Votes`[`Contest Name` == 'US SENATE' & `Choice Party` == 'REP'], na.rm=TRUE)/total_vote_senate,\n        total_vote_gov=sum(`Total Votes`[`Contest Name` == 'NC GOVERNOR'], na.rm=TRUE),\n        dem_share_gov=sum(`Total Votes`[`Contest Name` == 'NC GOVERNOR' & `Choice Party` == 'DEM'], na.rm=TRUE)/total_vote_gov,\n        gop_share_gov=sum(`Total Votes`[`Contest Name` == 'NC GOVERNOR' & `Choice Party` == 'REP'], na.rm=TRUE)/total_vote_gov,\n        total_vote_house=sum(`Total Votes`[grepl('US HOUSE OF REPRESENTATIVES DISTRICT', `Contest Name`)], na.rm=TRUE),\n        dem_share_house=sum(`Total Votes`[grepl('US HOUSE OF REPRESENTATIVES DISTRICT', `Contest Name`) & `Choice Party` == 'DEM'], na.rm=TRUE)/total_vote_house,\n        gop_share_house=sum(`Total Votes`[grepl('US HOUSE OF REPRESENTATIVES DISTRICT', `Contest Name`) & `Choice Party` == 'REP'], na.rm=TRUE)/total_vote_house\n    ) %>% ungroup() -> results_agg\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'County'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code}\ninner_join(results_agg, shapes, by=c('County'='county_nam', 'Precinct'='prec_id')) -> df_joined\nDT::datatable(df_joined %>% sample_n(size=100) %>% dplyr::select(-geometry), rownames = FALSE, options=list(scrollX=TRUE, autoWidth = TRUE))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-1770d66a86dcce969965\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1770d66a86dcce969965\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"WAKE\",\"WAKE\",\"SWAIN\",\"CRAVEN\",\"BUNCOMBE\",\"ORANGE\",\"GUILFORD\",\"HENDERSON\",\"HOKE\",\"GUILFORD\",\"DAVIDSON\",\"MECKLENBURG\",\"GUILFORD\",\"GUILFORD\",\"GASTON\",\"CARTERET\",\"GUILFORD\",\"RICHMOND\",\"LEE\",\"ROWAN\",\"WAYNE\",\"MADISON\",\"MECKLENBURG\",\"NEW HANOVER\",\"BUNCOMBE\",\"MECKLENBURG\",\"CUMBERLAND\",\"PENDER\",\"CASWELL\",\"HALIFAX\",\"WILKES\",\"WATAUGA\",\"NORTHAMPTON\",\"FRANKLIN\",\"ORANGE\",\"GUILFORD\",\"CABARRUS\",\"HENDERSON\",\"BRUNSWICK\",\"BUNCOMBE\",\"IREDELL\",\"RUTHERFORD\",\"CUMBERLAND\",\"MECKLENBURG\",\"BLADEN\",\"DURHAM\",\"BRUNSWICK\",\"CABARRUS\",\"BURKE\",\"MECKLENBURG\",\"ALEXANDER\",\"WAKE\",\"SAMPSON\",\"CABARRUS\",\"WAYNE\",\"WAKE\",\"HARNETT\",\"DURHAM\",\"CASWELL\",\"YANCEY\",\"ROBESON\",\"ROWAN\",\"COLUMBUS\",\"ALAMANCE\",\"RUTHERFORD\",\"ROBESON\",\"PERQUIMANS\",\"DURHAM\",\"WAKE\",\"JOHNSTON\",\"GUILFORD\",\"GUILFORD\",\"WILKES\",\"WAKE\",\"MADISON\",\"DAVIDSON\",\"STANLY\",\"GUILFORD\",\"GUILFORD\",\"MECKLENBURG\",\"PITT\",\"MECKLENBURG\",\"CLEVELAND\",\"RUTHERFORD\",\"PERQUIMANS\",\"ORANGE\",\"GUILFORD\",\"BRUNSWICK\",\"GUILFORD\",\"LENOIR\",\"UNION\",\"CUMBERLAND\",\"WAKE\",\"BERTIE\",\"UNION\",\"DAVIE\",\"RANDOLPH\",\"GASTON\",\"UNION\",\"FORSYTH\"],[\"16-07\",\"20-11\",\"WHCH\",\"20\",\"21.1\",\"CS1\",\"OR2\",\"SM\",\"01\",\"G32\",\"52\",\"141\",\"G05\",\"H26\",\"40\",\"ASCI\",\"G11\",\"13\",\"C1\",\"04\",\"11\",\"MARS H\",\"235\",\"W25\",\"34.1\",\"128\",\"CC21\",\"CF11\",\"ANDE\",\"HPR\",\"108\",\"02\",\"CREEKS\",\"11\",\"SJ\",\"G40A2\",\"07-00\",\"PV\",\"17\",\"39.2\",\"ST4\",\"14\",\"G4A\",\"113\",\"P502\",\"06\",\"05\",\"02-05\",\"0051\",\"001\",\"E\",\"18-01\",\"HARR\",\"12-04\",\"21\",\"20-04\",\"PR20\",\"35.3\",\"LEAS\",\"06 JAC\",\"17\",\"13\",\"P25B\",\"06E\",\"10A\",\"22\",\"PARKVI\",\"38\",\"16-01\",\"PR04\",\"H24\",\"FR5B\",\"101\",\"01-29\",\"HOT SP\",\"64\",\"0018\",\"NCGR1\",\"H01\",\"021\",\"0200B\",\"015\",\"LAWNDL\",\"06A\",\"BELVID\",\"WC\",\"H20B\",\"16\",\"G65\",\"FC\",\"029C\",\"MB62\",\"04-10\",\"W1\",\"012\",\"03\",\"AS\",\"18\",\"036\",\"304\"],[462,626,2005,2615,919,176,291,2513,274,270,3109,1788,192,197,3788,621,209,213,551,3340,196,2992,2103,1014,385,1858,2377,2618,699,237,204,297,134,1265,169,235,348,1289,5288,359,2375,1827,1099,2109,141,125,3280,463,2568,992,1962,493,1295,366,183,406,485,399,531,1197,252,1792,993,1780,1021,1799,1412,383,442,404,272,161,276,368,648,760,918,428,330,1410,399,2578,1362,2057,555,370,144,4433,280,3250,2139,1980,370,294,2155,1923,3108,4649,1669,1432],[0.3181818181818182,0.3370607028753994,0.571072319201995,0.3560229445506692,0.7366702937976061,0.3409090909090909,0.2061855670103093,0.2475129327497015,0.3722627737226277,0.3481481481481482,0.1366999035059505,0.8092841163310962,0.9427083333333334,0.350253807106599,0.3286694825765575,0.2045088566827697,0.6028708133971292,0.3145539906103286,0.2903811252268603,0.1772455089820359,0.7397959183673469,0.4154411764705883,0.5387541607227769,0.814595660749507,0.6285714285714286,0.6776103336921421,0.6848969289019773,0.2822765469824293,0.2532188841201717,0.4050632911392405,0.25,0.101010101010101,0.2985074626865671,0.5446640316205533,0.5266272189349113,0.5617021276595745,0.09770114942528736,0.339022498060512,0.367624810892587,0.5543175487465181,0.4509473684210527,0.3475643130815544,0.5632393084622384,0.4513987671882408,0.4326241134751773,0.776,0.3152439024390244,0.3520518358531318,0.3169781931464175,0.5766129032258065,0.2038735983690112,0.5699797160243407,0.6525096525096525,0.3825136612021858,0.5573770491803278,0.3842364532019704,0.4412371134020618,0.4987468671679198,0.4519774011299435,0.3057644110275689,0.4325396825396826,0.140625,0.07955689828801611,0.5168539325842697,0.188050930460333,0.4130072262367982,0.3803116147308782,0.7049608355091384,0.4027149321266968,0.2103960396039604,0.3198529411764706,0.4037267080745341,0.1014492753623188,0.358695652173913,0.3503086419753086,0.7013157894736842,0.2189542483660131,0.2336448598130841,0.6818181818181818,0.6468085106382979,0.5338345864661654,0.7540729247478666,0.4133627019089574,0.3947496353913466,0.2594594594594595,0.3891891891891892,0.3055555555555556,0.3584480036092939,0.5142857142857142,0.3076923076923077,0.3501636278634876,0.7772727272727272,0.3918918918918919,0.6360544217687075,0.1271461716937355,0.1606864274570983,0.2638352638352638,0.4902129490212949,0.2570401437986818,0.9594972067039106],[0.6320346320346321,0.6309904153354633,0.4049875311720698,0.6332695984703632,0.2448313384113167,0.625,0.7628865979381443,0.7373656983684839,0.6094890510948905,0.6222222222222222,0.8481826954004503,0.1616331096196868,0.04166666666666666,0.6243654822335025,0.6615628299894404,0.7938808373590982,0.3684210526315789,0.6713615023474179,0.6969147005444646,0.8077844311377246,0.2397959183673469,0.5711898395721925,0.442225392296719,0.1518737672583826,0.3402597402597403,0.3067814854682454,0.2965923432898612,0.6990068754774638,0.7396280400572246,0.5864978902953587,0.7303921568627451,0.8855218855218855,0.6940298507462687,0.4442687747035573,0.4437869822485207,0.4212765957446808,0.8908045977011494,0.6431342125678821,0.6263237518910741,0.4178272980501393,0.5322105263157895,0.6360153256704981,0.4158325750682438,0.5320056899004267,0.5531914893617021,0.192,0.6673780487804878,0.6285097192224622,0.6748442367601246,0.4122983870967742,0.7854230377166157,0.3610547667342799,0.3366795366795367,0.5792349726775956,0.4262295081967213,0.5862068965517241,0.5257731958762887,0.4461152882205514,0.5329566854990584,0.6791979949874687,0.5634920634920635,0.8448660714285714,0.9164149043303121,0.4646067415730337,0.8001958863858962,0.5764313507504168,0.6090651558073654,0.2637075718015666,0.5610859728506787,0.7821782178217822,0.6470588235294118,0.5652173913043478,0.8804347826086957,0.6086956521739131,0.6296296296296297,0.2868421052631579,0.7668845315904139,0.7383177570093458,0.306060606060606,0.3347517730496454,0.4511278195488722,0.2238169123351435,0.580029368575624,0.5887214389888187,0.7261261261261261,0.5864864864864865,0.6458333333333334,0.6336566659147305,0.4357142857142857,0.6843076923076923,0.6358111266947172,0.2065656565656566,0.5783783783783784,0.3639455782312925,0.8607888631090487,0.8231929277171087,0.722972972972973,0.492794149279415,0.7297783103654883,0.03072625698324022],[455,621,1976,2598,911,175,292,2491,270,271,3096,1761,189,198,3743,602,209,212,544,3318,193,2975,2082,1011,383,1851,2356,2589,688,236,202,294,133,1254,171,228,345,1280,5236,350,2351,1801,1089,2101,137,126,3235,463,2545,987,1943,485,1286,354,181,403,482,395,526,1201,247,1778,984,1768,1021,1743,1401,379,441,405,268,161,270,369,634,752,909,425,321,1400,389,2559,1351,2043,549,368,143,4382,278,3211,2119,1956,364,290,2129,1912,3068,4598,1651,1420],[0.3098901098901099,0.3075684380032206,0.5273279352226721,0.3498845265588915,0.7178924259055982,0.3371428571428571,0.1849315068493151,0.2316338819751104,0.3888888888888889,0.3284132841328413,0.1579457364341085,0.7705848949460534,0.9312169312169312,0.3131313131313131,0.3224686080683943,0.2408637873754153,0.5071770334928229,0.330188679245283,0.2941176470588235,0.1720916214587101,0.6943005181347151,0.4094117647058824,0.5081652257444764,0.76162215628091,0.6240208877284595,0.6477579686655862,0.6735993208828522,0.2877558903051371,0.2601744186046512,0.4110169491525424,0.2821782178217822,0.119047619047619,0.3007518796992481,0.5661881977671451,0.5087719298245614,0.5482456140350878,0.1217391304347826,0.32109375,0.3609625668449198,0.5171428571428571,0.4325818800510421,0.3486951693503609,0.5436179981634527,0.4036173250832937,0.4598540145985401,0.7698412698412699,0.3174652241112829,0.3239740820734341,0.3115913555992141,0.4721377912867274,0.215645908389089,0.534020618556701,0.6423017107309487,0.3644067796610169,0.5303867403314917,0.3399503722084367,0.454356846473029,0.4481012658227848,0.4733840304182509,0.3089092422980849,0.4574898785425101,0.1428571428571428,0.100609756097561,0.5118778280542986,0.1802154750244858,0.4239816408491107,0.3668807994289793,0.6517150395778364,0.4081632653061225,0.2320987654320988,0.3283582089552239,0.3850931677018634,0.1592592592592593,0.2655826558265583,0.3880126182965299,0.6795212765957447,0.2189218921892189,0.2,0.6728971962616822,0.5842857142857143,0.5347043701799485,0.7018366549433372,0.4167283493708364,0.3798335780714635,0.2622950819672131,0.3804347826086957,0.3356643356643357,0.3461889548151529,0.4568345323741007,0.3086265960759888,0.3289287399716848,0.7443762781186094,0.3324175824175824,0.6068965517241379,0.1202442461249413,0.1610878661087866,0.2672750977835723,0.4734667246628969,0.2465172622652938,0.9464788732394366],[0.6175824175824176,0.6264090177133655,0.3917004048582996,0.6158583525789069,0.2447859495060373,0.6285714285714286,0.75,0.7205941389000401,0.5666666666666667,0.6457564575645757,0.8000645994832042,0.1584327086882453,0.02116402116402116,0.6161616161616161,0.6321132781191557,0.7225913621262459,0.4066985645933014,0.6320754716981132,0.6213235294117647,0.7802893309222423,0.2538860103626943,0.547563025210084,0.4404418828049952,0.1552917903066271,0.3394255874673629,0.3079416531604538,0.2775891341256367,0.6431054461181923,0.7063953488372093,0.5550847457627118,0.6534653465346535,0.826530612244898,0.6616541353383458,0.39792663476874,0.456140350877193,0.4473684210526316,0.855072463768116,0.6375,0.6044690603514133,0.4171428571428571,0.5133985538068907,0.6007773459189339,0.3829201101928374,0.5678248453117563,0.4817518248175183,0.1904761904761905,0.61854714064915,0.6241900647948164,0.6243614931237721,0.5055724417426545,0.7323726196603191,0.3649484536082474,0.3234836702954899,0.5310734463276836,0.4143646408839779,0.5880893300248139,0.5,0.4708860759493671,0.4866920152091255,0.6486261448792673,0.4696356275303644,0.8093363329583803,0.8658536585365854,0.4389140271493213,0.7825661116552399,0.5306942053930006,0.6052819414703783,0.287598944591029,0.5034013605442177,0.7308641975308642,0.6007462686567164,0.577639751552795,0.7925925925925926,0.6964769647696477,0.555205047318612,0.2659574468085106,0.7337733773377337,0.7576470588235295,0.2897196261682243,0.3692857142857143,0.4138817480719794,0.255177803829621,0.53960029607698,0.5849241311796378,0.7158469945355191,0.5842391304347826,0.5734265734265734,0.6168416248288453,0.4064748201438849,0.6568047337278107,0.6314299197734781,0.1932515337423313,0.6071428571428571,0.3517241379310345,0.8496946923438234,0.7923640167364017,0.6942633637548892,0.4826011309264898,0.7135069654754694,0.02676056338028169],[460,622,1988,2610,911,176,294,2504,273,270,3106,1761,192,196,3757,622,210,212,546,3322,194,2984,2083,1017,387,1853,2365,2605,695,237,203,298,134,1264,172,226,345,1280,5261,353,2369,1808,1095,2110,139,125,3259,458,2562,991,1957,485,1289,360,182,402,484,401,526,1208,251,1791,987,1778,1022,1771,1410,381,441,405,269,158,273,370,640,756,918,428,323,1405,399,2569,1360,2052,554,370,142,4404,278,3236,2136,1972,365,290,2146,1923,3094,4633,1657,1429],[0.3978260869565217,0.3922829581993569,0.5829979879275654,0.3781609195402299,0.7683863885839737,0.3977272727272727,0.2448979591836735,0.2759584664536741,0.4505494505494506,0.4111111111111111,0.1838377334191887,0.817717206132879,0.9270833333333334,0.3826530612244898,0.3540058557359596,0.2556270096463023,0.580952380952381,0.3584905660377358,0.3534798534798535,0.2155328115593016,0.7268041237113402,0.4547587131367292,0.556409025444071,0.816125860373648,0.6795865633074936,0.6961683756071236,0.7128964059196617,0.3201535508637236,0.2964028776978417,0.4388185654008439,0.3054187192118227,0.151006711409396,0.3283582089552239,0.5886075949367089,0.5465116279069767,0.6858407079646017,0.1333333333333333,0.35859375,0.4092377874928721,0.5410764872521246,0.4774166314900802,0.3838495575221239,0.5945205479452055,0.4568720379146919,0.4676258992805755,0.824,0.3562442467014422,0.3602620087336245,0.3645589383294301,0.5721493440968718,0.2519161982626469,0.5793814432989691,0.6757176105508146,0.4138888888888889,0.5824175824175825,0.4278606965174129,0.487603305785124,0.5561097256857855,0.4904942965779467,0.3352649006622517,0.5976095617529881,0.1697375767727526,0.1094224924012158,0.5556805399325084,0.2113502935420744,0.5143986448334275,0.4014184397163121,0.7165354330708661,0.4693877551020408,0.2814814814814815,0.3903345724907063,0.4620253164556962,0.1648351648351648,0.4081081081081081,0.428125,0.7129629629629629,0.2668845315904139,0.2803738317757009,0.7337461300309598,0.6505338078291815,0.5714285714285714,0.7481510315297781,0.4433823529411764,0.4249512670565302,0.2888086642599278,0.4243243243243243,0.3802816901408451,0.4003178928247048,0.5215827338129496,0.334672435105068,0.3609550561797753,0.7925963488843814,0.4246575342465753,0.6344827586206897,0.1444547996272134,0.2043681747269891,0.3225597931480285,0.5180228793438377,0.2776101388050694,0.960111966410077],[0.5804347826086956,0.5932475884244373,0.3888329979879276,0.614176245210728,0.2151481888035126,0.5511363636363636,0.7278911564625851,0.7064696485623003,0.5384615384615384,0.5703703703703704,0.8068254990341275,0.1567291311754685,0.04166666666666666,0.5816326530612245,0.631354804365185,0.7363344051446945,0.3809523809523809,0.6367924528301887,0.6263736263736264,0.7730282962071041,0.2268041237113402,0.5315013404825737,0.4229476716274604,0.1514257620452311,0.3074935400516796,0.2908796546141392,0.2630021141649049,0.6579654510556622,0.6935251798561151,0.5527426160337553,0.6600985221674877,0.8322147651006712,0.6716417910447762,0.3995253164556962,0.4302325581395349,0.3097345132743363,0.8579710144927536,0.621875,0.5803079262497624,0.4164305949008499,0.5031658927817645,0.5995575221238938,0.3799086757990868,0.5303317535545023,0.5035971223021583,0.152,0.6213562442467014,0.6222707423580786,0.6272443403590945,0.4228052472250252,0.7393970362800204,0.3670103092783505,0.3134212567882079,0.5277777777777778,0.4065934065934066,0.5348258706467661,0.4958677685950413,0.4164588528678304,0.5,0.6473509933774835,0.3904382470119522,0.8179787828029034,0.8794326241134752,0.4274465691788527,0.7798434442270059,0.4743083003952569,0.5886524822695035,0.2519685039370079,0.4807256235827664,0.7111111111111111,0.5799256505576208,0.5316455696202531,0.8278388278388278,0.581081081081081,0.5515625,0.2619047619047619,0.7167755991285403,0.6985981308411215,0.2414860681114551,0.3359430604982206,0.4160401002506265,0.2331646555079798,0.5433823529411764,0.5653021442495126,0.7003610108303249,0.5648648648648649,0.5774647887323944,0.5899182561307902,0.4064748201438849,0.6551297898640297,0.6217228464419475,0.1754563894523327,0.547945205479452,0.3482758620689655,0.8466915191053123,0.7852314092563702,0.6690368455074337,0.4644938484783078,0.7109233554616777,0.02589223233030091],[457,605,1960,2559,904,173,289,2483,269,261,3096,1646,185,190,3589,578,207,211,533,3271,190,2969,1390,1000,382,1447,2329,2564,683,231,201,294,134,1234,169,224,342,1276,5206,352,2326,1764,1086,2100,134,122,3189,458,2534,674,1936,482,1276,352,177,393,472,391,511,1193,241,1755,972,1750,1006,1759,1396,370,431,405,259,156,271,364,631,749,901,415,315,1087,391,2176,1337,2030,551,363,142,4357,270,3188,2106,1950,362,288,2120,1908,2974,4438,1642,1394],[0.3413566739606127,0.3355371900826447,0.548469387755102,0.3368503321610004,0.7334070796460177,0.3815028901734104,0.2214532871972318,0.2384212645992751,0.3903345724907063,0.3601532567049808,0.1401808785529716,1,0.9621621621621622,0.4157894736842105,0.3304541655057119,0.2024221453287197,0.6183574879227053,0.3554502369668247,0.3095684803001876,0.1742586365025986,0.7368421052631579,0.4078814415628157,1,0.8179999999999999,0.6151832460732984,1,0.712322885358523,0.2905616224648986,0.2547584187408492,0.4025974025974026,0.2338308457711443,0.1292517006802721,0.2985074626865671,0.5818476499189628,0.5976331360946746,0.6428571428571429,0.1023391812865497,0.3221003134796238,0.3520937379946216,0.5255681818181818,0.4591573516766982,0.3424036281179138,0.5874769797421732,0.4138095238095238,0.4552238805970149,0.819672131147541,0.3116964565694575,0.3427947598253275,0.3208366219415943,1,0.2071280991735537,0.5643153526970954,0.646551724137931,0.4147727272727273,0.5819209039548022,0.361323155216285,0.4682203389830508,0.5242966751918159,0.4696673189823874,0.3093042749371333,0.4522821576763486,0.1504273504273504,0.09259259259259259,0.5222857142857142,0.1858846918489065,0.4360432063672541,0.3775071633237823,0.7081081081081081,0.4454756380510441,0.1802469135802469,0.3359073359073359,0.4294871794871795,0.1365313653136531,0.3104395604395604,0.3518225039619651,0.7022696929238985,0.2375138734739179,0.2240963855421687,0.6984126984126984,1,0.5294117647058824,1,0.4255796559461481,0.3788177339901478,0.2595281306715064,0.3966942148760331,0.3309859154929577,0.3426669726876291,0.5703703703703704,0.2882685069008783,0.335707502374169,0.7979487179487179,0.3701657458563536,0.6354166666666666,0.1245283018867925,0.1540880503144654,0.2673167451244116,0.4864803965750338,0.2673568818514007,0.9691535150645624],[0.6017505470459519,0.6264462809917355,0.3908163265306123,0.6631496678389996,0.2367256637168142,0.6184971098265896,0.7785467128027682,0.7333870318163512,0.6096654275092936,0.6398467432950191,0.8598191214470284,0,0.03783783783783784,0.5842105263157895,0.6536639732516021,0.7975778546712803,0.3816425120772947,0.6445497630331753,0.6904315196998124,0.8257413634974015,0.2631578947368421,0.5581003704951162,0,0.174,0.3429319371727749,0,0.287677114641477,0.7086583463338534,0.7452415812591509,0.5974025974025974,0.7213930348258707,0.826530612244898,0.7014925373134329,0.4181523500810373,0.4023668639053254,0.3571428571428572,0.8976608187134503,0.6496865203761756,0.6473300038417211,0.4176136363636364,0.5408426483233018,0.6383219954648526,0.4125230202578269,0.5861904761904762,0.5447761194029851,0.180327868852459,0.6857949200376293,0.6572052401746725,0.6586424625098658,0,0.7732438016528925,0.3630705394190871,0.3526645768025078,0.5852272727272727,0.4180790960451977,0.5928753180661578,0.5317796610169492,0.4757033248081842,0.5303326810176126,0.6647108130762783,0.5477178423236515,0.8495726495726496,0.9074074074074074,0.4777142857142857,0.8021868787276342,0.5639567936327459,0.6224928366762178,0.2918918918918919,0.4965197215777262,0.817283950617284,0.6640926640926641,0.5705128205128205,0.8228782287822878,0.6703296703296703,0.5974643423137876,0.2977303070761015,0.7624861265260822,0.7759036144578313,0.3015873015873016,0,0.4705882352941176,0,0.5482423335826477,0.5911330049261084,0.7404718693284936,0.6033057851239669,0.6690140845070423,0.6559559329814092,0.4296296296296296,0.7117314930991218,0.664292497625831,0.2020512820512821,0.585635359116022,0.3645833333333333,0.8754716981132076,0.8459119496855346,0.7326832548755884,0.5013519603424966,0.7326431181485993,0.03084648493543759],[2319,2363,2460,1498,1808,178,966,793,736,919,1361,466,885,964,1101,1652,890,9,638,2582,2127,556,515,237,1813,456,1461,104,1643,843,2079,2130,208,1123,171,1001,1738,788,1868,1818,712,2564,1430,447,1895,1254,1857,1720,1763,337,1978,2335,2548,1731,2118,2358,831,1304,1644,2030,2646,2588,1529,2013,2577,2653,101,1300,2313,651,1007,1018,2072,2177,555,1367,2519,1003,925,375,60,364,1548,2575,97,175,985,1863,918,617,2430,1468,2247,1904,2399,1327,20,1077,2415,1186],[\"16-07\",\"20-11\",\"WHCH\",\"FAIRFIELD HARBOUR\",\"HAW CREEK ELEMENTARY SCHOOL\",\"COLES STORE\",\"OR2\",\"SOUTH MILLS RIVER\",\"ALLENDALE\",\"G32\",\"SILVER HILL 52\",\"141\",\"G05\",\"H26\",\"DALLAS  1\",\"Atlantic/Sea Level/Cedar Island\",\"G11\",\"MINERAL SPRINGS  2\",\"C1\",\"BRADSHAW\",\"11\",\"MARS HILL\",\"235\",\"W25\",\"BLACK MOUNTAIN 3 - LAKE TOMAHAWK\",\"128\",\"CROSS CREEK 21\",\"CAPE FEAR\",\"ANDERSON\",\"HOBGOOD\",\"FAIRPLAINS\",\"BEAVER DAM\",\"CREEKSVILLE\",\"SANDY CREEK\",\"ST JOHN\",\"G40A2\",\"07-00\",\"PISGAH VIEW\",\"LONGWOOD\",\"FAIRVIEW VOLUNTEER FIRE DEPT\",\"STATESVILLE  4\",\"FOREST CITY  2\",\"CROSS CREEK 30-G4\",\"113\",\"ELIZABETHTOWN  2\",\"LAKEWOOD SCHOOL\",\"TOWNCREEK\",\"02-05\",\"SILVER CREEK 01\",\"001\",\"ELLENDALE\",\"18-01\",\"HARRELLS\",\"12-04\",\"21\",\"20-04\",\"STEWARTS CREEK\",\"0035.3\",\"LEASBURG\",\"JACKS CREEK\",\"LUMBERTON  7\",\"ROCK GROVE\",\"WILLIAMS 2\",\"EAST GRAHAM\",\"DUNCAN CREEK-GOLDEN VALLEY\",\"NORTH PEMBROKE\",\"PARKVILLE\",\"HOPE VALLEY BAPTIST\",\"16-01\",\"BENTONVILLE\",\"H24\",\"FR5B\",\"ANTIOCH\",\"01-29\",\"HOT SPRINGS\",\"THOMASVILLE 3 64\",\"RICHFIELD\",\"NCGR1\",\"H01\",\"021\",\"AYDEN B\",\"015\",\"LAWNDL\",\"CHIMNEY ROCK\",\"BELVIDERE\",\"WHITE CROSS\",\"H20B\",\"SHINGLETREE 1\",\"G65\",\"FALLING CREEK\",\"STALLINGS VFD\",\"MONTIBELLO\",\"04-10\",\"WINDSOR 1\",\"BETHLEHEM PRESBYTERIAN CHURCH\",\"CLARKSVILLE\",\"ASHEBORO SOUTH\",\"ASHBROOK\",\"CROSSROADS AME ZION CHURCH\",\"FORSYTH TECH CC MAZIE WOODRUFF CTR\"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[92,92,87,25,11,68,41,45,47,41,29,60,41,41,36,16,41,77,53,80,96,57,60,65,11,60,26,71,17,42,97,95,66,35,68,41,13,45,10,11,49,81,26,60,9,32,10,13,12,60,2,92,82,13,96,92,43,32,17,100,78,80,24,1,81,78,72,32,92,51,41,41,97,92,57,29,84,41,41,60,74,60,23,81,72,68,41,10,41,54,90,26,92,8,90,30,76,36,90,34],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th>County<\\/th>\\n      <th>Precinct<\\/th>\\n      <th>total_vote_pres<\\/th>\\n      <th>dem_share_pres<\\/th>\\n      <th>gop_share_pres<\\/th>\\n      <th>total_vote_senate<\\/th>\\n      <th>dem_share_senate<\\/th>\\n      <th>gop_share_senate<\\/th>\\n      <th>total_vote_gov<\\/th>\\n      <th>dem_share_gov<\\/th>\\n      <th>gop_share_gov<\\/th>\\n      <th>total_vote_house<\\/th>\\n      <th>dem_share_house<\\/th>\\n      <th>gop_share_house<\\/th>\\n      <th>id<\\/th>\\n      <th>enr_desc<\\/th>\\n      <th>of_prec_id<\\/th>\\n      <th>county_id<\\/th>\\n      <th>blockid<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"scrollX\":true,\"autoWidth\":true,\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3,4,5,6,7,8,9,10,11,12,13,14,17]},{\"name\":\"County\",\"targets\":0},{\"name\":\"Precinct\",\"targets\":1},{\"name\":\"total_vote_pres\",\"targets\":2},{\"name\":\"dem_share_pres\",\"targets\":3},{\"name\":\"gop_share_pres\",\"targets\":4},{\"name\":\"total_vote_senate\",\"targets\":5},{\"name\":\"dem_share_senate\",\"targets\":6},{\"name\":\"gop_share_senate\",\"targets\":7},{\"name\":\"total_vote_gov\",\"targets\":8},{\"name\":\"dem_share_gov\",\"targets\":9},{\"name\":\"gop_share_gov\",\"targets\":10},{\"name\":\"total_vote_house\",\"targets\":11},{\"name\":\"dem_share_house\",\"targets\":12},{\"name\":\"gop_share_house\",\"targets\":13},{\"name\":\"id\",\"targets\":14},{\"name\":\"enr_desc\",\"targets\":15},{\"name\":\"of_prec_id\",\"targets\":16},{\"name\":\"county_id\",\"targets\":17},{\"name\":\"blockid\",\"targets\":18}],\"order\":[],\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n## Add some geographic features\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined$geometry %>%\n    st_centroid() %>%\n    st_transform(\"+init=epsg:4326\") %>%\n    st_coordinates() -> latlong\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in CPL_crs_from_input(x): GDAL Message 1: +init=epsg:XXXX syntax is\ndeprecated. It might return a CRS with a non-EPSG compliant axis order. Further\nmessages of this type will be suppressed.\n```\n\n\n:::\n\n```{.r .cell-code}\ndf_joined$longitude = latlong[, 'X']\ndf_joined$latitude = latlong[, 'Y']\narea = df_joined$geometry %>% st_transform(\"+init=epsg:4326\") %>% st_area()\ndf_joined$area_km2 = units::drop_units(area) / 1e6 # convert m^2 to km^2\ndf_joined <- df_joined %>% mutate(vote_density_pres = total_vote_pres / area_km2)\n```\n:::\n\n\n\n# Assign treatment four ways\n\n::: {.panel-tabset}\n\n## Softblock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstart_time = lubridate::now()\ndf_joined %>% assign_softblock(c(\n    longitude, latitude, area_km2, vote_density_pres, # geographic\n    total_vote_pres, dem_share_pres, gop_share_pres, # 2020 presidential\n    total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n    total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n    total_vote_house, dem_share_house, gop_share_house # 2020 house\n)) %>%\nrename(treatment_sb=treatment)-> df_joined\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: The `normalized` argument of `make_lattice()` provide normalization instead as\nof igraph 2.0.3.\nℹ `normalized` is now deprecated, use `normalization` instead.\n```\n\n\n:::\n\n```{.r .cell-code}\nsoftblock_weights <- attr(df_joined, \"laplacian\")\nend_time = lubridate::now()\nprint(end_time - start_time)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTime difference of 0.7473469 secs\n```\n\n\n:::\n:::\n\n\n\n\n## Greedy nearest neighbors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstart_time = lubridate::now()\ndf_joined %>% assign_greedy_neighbors(c(\n    longitude, latitude, area_km2, vote_density_pres, # geographic\n    total_vote_pres, dem_share_pres, gop_share_pres, # 2020 presidential\n    total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n    total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n    total_vote_house, dem_share_house, gop_share_house # 2020 house\n)) %>%\nrename(treatment_nn=treatment)-> df_joined\nnn_weights <- attr(df_joined, \"laplacian\")\nend_time = lubridate::now()\nprint(end_time - start_time)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTime difference of 1.482411 secs\n```\n\n\n:::\n:::\n\n\n\n\n## QuickBlock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstart_time = lubridate::now()\ndf_joined %>% dplyr::select(\n    longitude, latitude, area_km2, vote_density_pres, # geographic\n    total_vote_pres, dem_share_pres, gop_share_pres, # 2020 presidential\n    total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n    total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n    total_vote_house, dem_share_house, gop_share_house # 2020 house\n) -> df_qb\nqb_blocks = quickblock(as.data.frame(df_qb), size_constraint = 6L)\ndf_joined$treatment_qb = as.integer(as.character(assign_treatment(qb_blocks, treatments=c('0', '1'))))\nend_time = lubridate::now()\nprint(end_time - start_time)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTime difference of 0.03046703 secs\n```\n\n\n:::\n:::\n\n\n\n\n## Matched Pairs\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This is extremely slow.\n# start_time = lubridate::now()\n# df_joined %>% assign_matched_pairs(c(\n#     longitude, latitude, area_km2, vote_density_pres, # geographic\n#     total_vote_pres, dem_share_pres, gop_share_pres, # 2020 presidential\n#     total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n#     total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n#     total_vote_house, dem_share_house, gop_share_house # 2020 house\n# )) %>%\n# rename(treatment_mp=treatment)-> df_joined\n# mp_weights <- attr(df_joined, \"laplacian\")\n# end_time = lubridate::now()\n# print(end_time - start_time)\n```\n:::\n\n\n\n:::\n\n\n# Power simulation\n\nTo do power calculations consistently across methods, I will do the following:\n\n1. Calculate the implied regression adjustment for each design, applied to vote share in 2020 as the outcome.\n2. Find the residual for each point.\n3. Permute residuals over units.\n4. Estimate power for a given effect size by pulling additional permutations.\n5. Sweep over a range of effect sizes.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncreate_power_simulator = function(W, A, Y) {\n    dL = diag(W)\n    Dinv = (2 * A - 1) / dL\n    estimates = drop((Dinv %*% W) %*% Y)\n    residuals = Y - estimates\n    x_mat = cbind(A, 1)\n    xlx = t(x_mat) %*% W %*% x_mat\n    bread = MASS::ginv(as.matrix(xlx))\n    detect_effect = function(effect=1) {\n        sim_outcome = estimates + sample(residuals) + A * effect\n        coefs = bread %*% t(x_mat) %*% W %*% sim_outcome\n        r = diag(drop((sim_outcome - (x_mat %*% coefs)) ^ 2))\n        meat = t(x_mat) %*% (W %*% r %*% W) %*% x_mat\n        vcv = bread %*% meat %*% bread\n        upr = coefs[1] + qnorm(0.975) * sqrt(vcv[1])\n        lwr = coefs[1] + qnorm(0.025) * sqrt(vcv[1])\n        lwr > 0\n    }\n    detect_effect\n}\ncreate_power_simulator_qb = function(blocks, A, Y) {\n    estimate_by_block = tapply(Y[A==1], blocks[A==1], mean) - tapply(Y[A==0], blocks[A==0], mean)\n    estimates = unlist(purrr::map(blocks, function(b) estimate_by_block[as.character(b)]))\n    residuals = Y - estimates\n    detect_effect = function(effect=1) {\n        sim_outcome = estimates + sample(residuals) + A * effect\n        result = quickblock::blocking_estimator(sim_outcome, blocks, A)\n        upr = result$effects[2,1] + qnorm(0.975) * sqrt(result$effect_variances[2,1])\n        lwr = result$effects[2,1] + qnorm(0.025) * sqrt(result$effect_variances[2,1])\n        lwr > 0\n    }\n    detect_effect\n}\n```\n:::\n\n\n\n## Simulate each design\n\n::: {.panel-tabset}\n\n### Softblock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimulate_power = create_power_simulator(softblock_weights, df_joined$treatment_sb, df_joined$dem_share_pres)\nestimate_power_for_effect = function(effect) mean(replicate(25, simulate_power(effect=effect)))\neffects = seq(0, 0.05, length=25)\npower_sb = unlist(purrr::map(effects, estimate_power_for_effect))\n```\n:::\n\n\n\n\n### Greedy Neighbors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimulate_power = create_power_simulator(nn_weights, df_joined$treatment_nn, df_joined$dem_share_pres)\nestimate_power_for_effect = function(effect) mean(replicate(25, simulate_power(effect=effect)))\npower_nn = unlist(purrr::map(effects, estimate_power_for_effect))\n```\n:::\n\n\n\n\n### QuickBlock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimulate_power = create_power_simulator_qb(qb_blocks, df_joined$treatment_qb, df_joined$dem_share_pres)\nestimate_power_for_effect = function(effect) mean(replicate(25, simulate_power(effect=effect)))\neffects = seq(0, 0.05, length=25)\npower_qb = unlist(purrr::map(effects, estimate_power_for_effect))\n```\n:::\n\n\n\n:::\n\n## Power Comparison\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n    tibble(\n        effects=c(effects, effects, effects),\n        power=c(power_sb, power_nn, power_qb),\n        design=c(rep('SoftBlock', length(power_sb)), rep('Greedy Neighbors', length(power_sb)), rep('QuickBlock', length(power_sb)))\n    ), aes(effects, power, color=design)) + geom_line() +\n    scale_x_continuous('Effect (pp)', labels=scales::percent) +\n    scale_y_continuous(\"Power\", labels=scales::percent) +\n    scale_color_discrete(\"Design\") +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/power_plot-1.png){width=672}\n:::\n:::\n\n\n\n\n# Analysis\n\n## Average Effects\n\nThe effect estimates here use the appropriate design-based estimators for each design.\n\nFirst, I'm going to generate a fake outcome to use. I'll leave the average effect near zero (0.5pp), but individual effects are random draws from around that vale, but with heterogeneous effects based on democratic vote share in 2020 (i.e. positive effects in democratic precincts and vice versa).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined$outcome = df_joined$dem_share_pres\ndf_joined$ite = with(df_joined, 0.005 + 0.005 * (plogis((dem_share_pres - median(dem_share_pres)) / sd(dem_share_pres))))\ndf_joined$outcome_sb = with(df_joined, outcome + treatment_sb * ite)\ndf_joined$outcome_nn = with(df_joined, outcome + treatment_nn * ite)\ndf_joined$outcome_qb = with(df_joined, outcome + treatment_qb * ite)\n```\n:::\n\n\n\n\n::: {.panel-tabset}\n\n### Softblock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nestimate_effect = function(W, A, Y) {\n    dL = diag(W)\n    Dinv = (2 * A - 1) / dL\n    x_mat = cbind(A, 1)\n    xlx = t(x_mat) %*% W %*% x_mat\n    bread = MASS::ginv(as.matrix(xlx))\n    coefs = bread %*% t(x_mat) %*% W %*% Y\n    r = diag(drop((Y - (x_mat %*% coefs)) ^ 2))\n    meat = t(x_mat) %*% (W %*% r %*% W) %*% x_mat\n    vcv = bread %*% meat %*% bread\n    list(estimate=coefs[1], std.error=sqrt(vcv[1,1]))\n}\nsb_est = estimate_effect(softblock_weights, df_joined$treatment_sb, df_joined$outcome_sb)\n```\n:::\n\n\n\n\n### Greedy Neighbors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnn_est = estimate_effect(nn_weights, df_joined$treatment_nn, df_joined$outcome_nn)\n```\n:::\n\n\n\n\n### QuickBlock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresult = quickblock::blocking_estimator(df_joined$outcome_qb, qb_blocks, df_joined$treatment_qb)\nqb_est = list(estimate=result$effects[2,1], std.error=sqrt(result$effect_variances[2,1]))\n```\n:::\n\n\n\n\n:::\n\n## Plot Average Effects\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(\n    estimate=c(sb_est$estimate, nn_est$estimate, qb_est$estimate),\n    std.error=c(sb_est$std.error, nn_est$std.error, qb_est$std.error),\n    design=c(\"SoftBlock\", \"Greedy Neighbors\", \"QuickBlock\")\n) %>%\nggplot(aes(x=design, y=estimate, ymin=estimate-1.96*std.error, ymax=estimate+1.96*std.error)) +\n    geom_pointrange() +\n    scale_x_discrete(\"Design\") +\n    scale_y_continuous(\"ATE (pp)\", labels=scales::percent) +\n    coord_flip() +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot_fx-1.png){width=672}\n:::\n:::\n\n\n\n\n## Heterogeneous Effects\n\nThese effects will be estimated using DR-learner of [Kennedy (2020)](https://arxiv.org/abs/2004.14497). For simplicity, I will estimate nuisance functions using `glmnet`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict.hte.split = function(x, a, y, s, predict.s=4) {\n    s.pi = (predict.s) %% 4 + 1\n    s.mu = (predict.s + 1) %% 4 + 1\n    s.dr = (predict.s + 2) %% 4 + 1\n    pihat <- predict(cv.glmnet(x[s==s.pi,],a[s==s.pi], family=\"binomial\", nfolds=10), newx=x, type=\"response\", s=\"lambda.min\")\n    mu0hat <- predict(cv.glmnet(x[a==0 & s==s.mu,],y[a==0 & s==s.mu], nfolds=10), newx=x, type=\"response\", s=\"lambda.min\")\n    mu1hat <- predict(cv.glmnet(x[a==1 & s==s.mu,],y[a==1 & s==s.mu], nfolds=10),newx=x, type=\"response\", s=\"lambda.min\")\n    pseudo <- ((a-pihat)/(pihat*(1-pihat)))*(y-a*mu1hat-(1-a)*mu0hat) + mu1hat - mu0hat\n    drl <- predict(cv.glmnet(x[s==s.dr,],pseudo[s==s.dr]),newx=x[s==predict.s, ], s=\"lambda.min\")\n    drl\n}\npredict.hte.crossfit = function(x, a, y) {\n    N = length(a)\n    s = sample(1:4, N, replace=TRUE)\n    hte = rep(NA_real_, N)\n    for (split in 1:4) {\n        hte[s==split] = predict.hte.split(x, a, y, s, predict.s=split)\n    }\n    hte\n}\ncalculate_hte <- function(.data, cols, .treatment='treatment', .outcome='outcome') {\n    expr <- rlang::enquo(cols)\n    pos <- tidyselect::eval_select(expr, data = .data)\n    df_cov <- rlang::set_names(.data[pos], names(pos))\n    cov_mat = scale(model.matrix(~.+0, df_cov))\n    .data$hte = predict.hte.crossfit(cov_mat, .data[[.treatment]], .data[[.outcome]])\n    .data\n}\n```\n:::\n\n\n\n\n## Estimate HTEs\n\n::: {.panel-tabset}\n\n### Softblock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined %>% calculate_hte(c(\n    longitude, latitude, area_km2, vote_density_pres, # geographic\n    total_vote_pres, # 2020 presidential\n    total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n    total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n    total_vote_house, dem_share_house, gop_share_house # 2020 house\n), .treatment='treatment_sb', .outcome='outcome_sb') %>% rename(hte_sb=hte) -> df_joined\nsummary(df_joined$hte_sb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. \n-0.010306  0.004135  0.007536  0.007148  0.009029  0.033580 \n```\n\n\n:::\n:::\n\n\n\n\n### Greedy Neighbors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined %>% calculate_hte(c(\n    longitude, latitude, area_km2, vote_density_pres, # geographic\n    total_vote_pres, # 2020 presidential\n    total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n    total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n    total_vote_house, dem_share_house, gop_share_house # 2020 house\n), .treatment='treatment_nn', .outcome='outcome_nn') %>% rename(hte_nn=hte) -> df_joined\nsummary(df_joined$hte_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n0.005742 0.006825 0.007388 0.007670 0.008596 0.010863 \n```\n\n\n:::\n:::\n\n\n\n\n### QuickBlock\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_joined %>% calculate_hte(c(\n    longitude, latitude, area_km2, vote_density_pres, # geographic\n    total_vote_pres, # 2020 presidential\n    total_vote_senate, dem_share_senate, gop_share_senate, # 2020 senate\n    total_vote_gov, dem_share_gov, gop_share_gov, # 2020 governor\n    total_vote_house, dem_share_house, gop_share_house # 2020 house\n), .treatment='treatment_qb', .outcome='outcome_qb') %>% rename(hte_qb=hte) -> df_joined\nsummary(df_joined$hte_qb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. \n-0.0007862  0.0070832  0.0083612  0.0082249  0.0094074  0.0398552 \n```\n\n\n:::\n:::\n\n\n\n\n:::\n\n## Plot HTE distributions\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df_joined, aes()) +\ngeom_histogram(aes(x=hte_sb, fill='SoftBlock'), bins=50, alpha=0.4) +\ngeom_histogram(aes(x=hte_nn, fill='Greedy Neighbors'), bins=50, alpha=0.4) +\ngeom_histogram(aes(x=hte_qb, fill='QuickBlock'), bins=50, alpha=0.4) +\nscale_x_continuous(\"Effect (pp)\", labels=scales::percent) +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/hte_plot-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/datatables-binding-0.34.0/datatables.js\"></script>\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}